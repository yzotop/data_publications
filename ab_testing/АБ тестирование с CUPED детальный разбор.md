---
tags:
  - data
data_type:
  - AB tests
source: habr
link: https://habr.com/ru/companies/X5Tech/articles/780270/
author: Nazarov
---

Хабр, привет! Сегодня обсудим, как применять CUPED для повышения чувствительности А/Б тестов. Рассмотрим на простом примере принцип работы CUPED, покажем теоретически за счёт чего снижается дисперсия и приведём пример оценки эксперимента. Обсудим, как выбирать ковариату, как работать с бинарными метриками и что делать при противоречивых результатах.

Меня зовут [Коля](http://www.linkedin.com/in/nazarovn), я работаю аналитиком данных в X5 Tech. Мы с [Сашей](http://www.linkedin.com/in/amsakhnov) продолжаем писать серию статей по А/Б тестированию. Предыдущие статьи можно посмотреть тут:

- [Стратификация. Как разбиение выборки повышает чувствительность А/Б теста](https://habr.com/ru/company/X5Tech/blog/596279/);
- [Бутстреп и А/Б тестирование](https://habr.com/ru/company/X5Tech/blog/679842/);
- [Проверка корректности А/Б тестов](https://habr.com/ru/company/X5Tech/blog/706388/);
- [А/Б тесты с метрикой отношения. Дельта-метод](https://habr.com/ru/companies/X5Tech/articles/740476/);
- [Определяем оптимальный размер групп при множественном А/Б тестировании](https://habr.com/ru/companies/X5Tech/articles/763656/).
    

## CUPED

Повышение чувствительности А/Б тестов делает эксперименты более эффективными. При фиксированных вероятностях ошибок более чувствительный тест находит эффекты меньшего размера или требует меньший объём данных.

CUPED (Controlled-experiment Using Pre-Experiment Data) — техника увеличения чувствительности А/Б тестов за счёт использования данных, полученных ранее.

Продемонстрируем идею, на которой основан CUPED. Допустим, мы проводим эксперимент в онлайн магазине. Хотим что-то изменить на сайте магазина и ожидаем, что средняя выручка с пользователя увеличится. Эксперимент проводим одну неделю. Выбираем случайным образом две группы пользователей. Для пользователей контрольной группы ничего не меняем, для пользователей экспериментальной группы внедряем изменение. После окончания эксперимента считаем суммарную стоимость покупок для каждого пользователя и проверяем гипотезу о равенстве средних с помощью теста Стьюдента. Гипотезу проверяем на уровне значимости 0.05.

Для простоты рассмотрим группы из пяти пользователей. Результаты эксперимента приведены на картинке ниже. Среднее значение суммарной выручки с пользователя в экспериментальной группе больше на 40 рублей. Отличия статистически незначимые, p-value равно 0.87.

![](https://habrastorage.org/r/w1560/getpro/habr/upload_files/1a9/c92/c91/1a9c92c9113cea633addb822c05c8862.png)

Просто применив тест Стьюдента, статистически значимых отличий найти не удалось. Посмотрим на данные о покупках пользователей до эксперимента:

![](https://habrastorage.org/r/w1560/getpro/habr/upload_files/9df/ec6/8a3/9dfec68a391eb0502c74e94bee8aea83.png)

Из графиков видно, что пользователи до эксперимента каждую неделю совершали покупки на одну и ту же стоимость. Стоимость покупок пользователя во время эксперимента равна стоимости его покупок до эксперимента плюс эффект эксперимента. Средние стоимости покупок в группах А и Б до эксперимента в среднем совпадают, так как группы формировались случайно из одного распределения. В таком случае изначальная гипотеза о равенстве средних эквивалентна гипотезе о равенстве приращений во время эксперимента. Приращения для каждого пользователя подписаны на картинке справа от графиков.

Среднее значение приращений во время эксперимента в экспериментальной группе больше на 30 рублей. P-value равно 0.007, отличия статистически значимые. Благодаря переходу от стоимости покупок к приращениям, мы смогли обнаружить эффект. Это произошло из-за того, что точечная оценка эффекта осталась примерно той же, а разброс данных сильно уменьшился. Среднеквадратичное отклонение исходных данных равно 276, а приращений — 19.

Трюк, описанный выше, является частным случаем CUPED. На практике данные не такие хорошие, пользователи не покупают товары на одну и ту же стоимость каждую неделю. Тем не менее, какие-то зависимости в поведении пользователей есть. Эти зависимости позволяют повысить чувствительность тестов с помощью CUPED.

## Теория

Ковариата — это метрика, скоррелированная с метрикой эксперимента, которая не зависит от эксперимента. В качестве ковариаты часто берут значения метрики эксперимента, посчитанные на периоде до эксперимента. Обозначим значения метрики эксперимента как Y, а значения ковариаты как X.

Суть метода CUPED состоит в переходе от метрики ![Y](https://habrastorage.org/getpro/habr/upload_files/a02/f19/49c/a02f1949cc0cf7e959e191f27c454869.svg)к метрике ![Y_{cuped}](https://habrastorage.org/getpro/habr/upload_files/d0d/d57/771/d0dd57771b6b25ac1050f39a50d3720f.svg), которая вычисляется по формуле:

![Y_{cuped} = Y - \theta X](https://habrastorage.org/getpro/habr/upload_files/434/a95/003/434a95003f941f4f107266aadc19c530.svg)

, где ![\theta](https://habrastorage.org/getpro/habr/upload_files/bec/799/fab/bec799fab74348cf8bd26ff3a31b7939.svg) — некоторое действительное число.

Для каждого объекта в контрольной и экспериментальной группе нужно получить значения целевой метрики и ковариаты, и по ним для каждого объекта вычислить значение новой CUPED-метрики. Значения CUPED-метрики контрольной и экспериментальной групп будут подаваться в статистический критерий для проверки гипотезы.

Точечная оценка эффекта вычисляется как разница средних значений метрики в контрольной и экспериментальной группах. Если пользователи по группам распределяются случайно, и ковариата не зависит от эксперимента, то при замене исходной метрики на CUPED-метрику точечная оценка эффекта будет несмещённой.

Чем меньше дисперсия, тем больше чувствительность теста. Посмотрим, как меняется дисперсия оценки среднего при переходе к CUPED-метрике:

![\mathbb{V}\overline{Y}_{cuped} = \mathbb{V}\left(\overline{Y} - \theta \overline{X}\right) = \dfrac{\mathbb{V}\left(Y - \theta X\right)}{n} = \dfrac{\mathbb{V} Y - 2\theta\mathrm{cov}\left(Y,X\right) + \theta^2\mathbb{V} X}{n}](https://habrastorage.org/getpro/habr/upload_files/5b0/3ff/8f2/5b03ff8f2b5f5508734282e857d80194.svg)

Дисперсия зависит от ![\theta](https://habrastorage.org/getpro/habr/upload_files/0e8/e3a/827/0e8e3a827d3623b9a7524463e8b916ac.svg) квадратично. Это простая парабола с точкой минимума:

![\theta_0 = \frac{\mathrm{cov}(Y,X)}{\mathbb{V} X}](https://habrastorage.org/getpro/habr/upload_files/0b1/25c/c24/0b125cc249f767dfee185a31c3a82e7e.svg)

Минимальная дисперсия равна:

![\min\left(\mathbb{V} \overline{Y}_{cuped}\right) = \mathbb{V} \overline{Y} \cdot \left(1 - \rho^2\right), \qquad где \ \rho = \frac{\mathrm{cov}(Y,X)} {\sqrt{\mathbb{V} Y \mathbb{V} X}}](https://habrastorage.org/getpro/habr/upload_files/c9b/e0c/af2/c9be0caf28a4153765359511d15d5bb6.svg)

Чем сильнее ковариата коррелирует с целевой метрикой, тем сильнее с помощью CUPED можно снизить дисперсию.

Алгоритм применения CUPED:

1. вычислить значения исходной метрики ![Y](https://habrastorage.org/getpro/habr/upload_files/521/b4e/06a/521b4e06a7783661caf220fdca68c6e7.svg) для каждого пользователя в контрольной и экспериментальной группах;
    
2. вычислить значения ковариаты ![X](https://habrastorage.org/getpro/habr/upload_files/4d6/f25/ada/4d6f25ada747b13135a5cb0425b5aeaf.svg) для каждого пользователя в контрольной и экспериментальной группах;
    
3. вычислить параметр ![\theta](https://habrastorage.org/getpro/habr/upload_files/df5/9da/6d5/df59da6d58e47493ea77c2ec2a375f3c.svg) по формуле ![\theta = \frac{\mathrm{cov}(Y,X)}{\mathbb{V} X}](https://habrastorage.org/getpro/habr/upload_files/255/70f/5ab/25570f5ab9641be8c3b1bf477a9720e9.svg);
    
4. для каждого пользователя вычислить CUPED-метрику по формуле ![Y_{cuped} = Y - \theta X](https://habrastorage.org/getpro/habr/upload_files/17c/4f8/afd/17c4f8afdfce68967726dd1e318a12cc.svg);
    
5. применить статистический тест на значениях CUPED-метрики контрольной и экспериментальной групп.
    

Пример вычислений:

|   |   |   |   |   |
|---|---|---|---|---|
|**группа**|**ковариата**|**метрика**|**theta**|**CUPED-метрика**|
|0|4|5|0.5|3|
|1|5|7|0.5|4.5|
|1|6|8|0.5|5|
|0|7|7|0.5|3.5|
|0|8|7|0.5|3|

```
stattest([3, 3.5, 3], [4.5, 5])
```

## Практика

Покажем, как применять CUPED в коде. Напишем функции для генерации коррелированных данных, оценки параметра ![\theta](https://habrastorage.org/getpro/habr/upload_files/6bc/75e/787/6bc75e787cf0ad9fd49c0b72d9c37426.svg) и вычисления p-value. Сгенерируем данные контрольной и экспериментальной групп. Искусственно добавим эффект к данным экспериментальной группы. Применив CUPED, получим значение p-value.

Код

```

```

Проверим корректность полученного критерия и сравним его с тестом Стьюдента. Для этого проведём большое количество симуляций оценки экспериментов и построим распределения p-value.

Код

```

```

![](https://habrastorage.org/r/w1560/getpro/habr/upload_files/5f1/375/67e/5f137567e34217ce474d10f077058828.png)

CUPED работает корректно, p-value на А/А тестах распределены равномерно. CUPED имеет большую мощность, чем тест Стьюдента, p-value на А/Б тестах у CUPED выпукло сильнее. Про корректность работы критериев можно прочитать в статье [Проверка корректности А/Б тестов](https://habr.com/ru/company/X5Tech/blog/706388/).

Легко проверить, что при корреляции ковариаты с целевой метрикой, равной нулю, мощность CUPED совпадает с мощностью теста Стьюдента, а чем сильнее корреляция отличается от нуля, тем мощнее CUPED.

## Ковариаты

Самое сложно в использовании CUPED — это выбор ковариаты. От ковариаты зависит, насколько чувствительнее станет критерий. Можно придумать огромное количество вариантов ковариат. Обсудим некоторые из них. Напомним определение. 

Ковариата — это метрика, скоррелированная с метрикой эксперимента, которая не зависит от эксперимента.

Скоррелированность влияет на уменьшение дисперсии. Чем сильнее ковариата коррелирует с метрикой, тем сильнее уменьшается дисперсия. Независимость важна, так как иначе критерий может стать некорректным. Например, если взять в качестве ковариаты саму метрику во время эксперимента, то все значения CUPED-метрики в обеих группах будут равны одному и тому же значению, критерий всегда будет говорить, что значимых отличий нет.

В качестве ковариаты часто берут значения метрики эксперимента, посчитанные на периоде до эксперимента. Корреляция ковариаты с метрикой обусловлена сохраняющимся поведением исследуемых объектов в течение времени. Проводимый эксперимент не влияет на события случившиеся до его начала, поэтому такая ковариата не зависит от эксперимента. Главное преимущество этой ковариаты – в её простоте. Легко посчитать, сложно ошибиться.

Чтобы сильнее снизить дисперсию, можно поэкспериментировать с продолжительностью периода для вычисления ковариаты. Например, проверяем гипотезу об изменении средней выручки с покупателя. Если эксперимент идёт неделю, то можно в качестве ковариаты использовать как выручку с пользователя за неделю до эксперимента, так и выручку с пользователя за 4 или 8 недель до эксперимента. Такой подход работает лучше для редких событий, когда пользователи покупают в среднем реже одного раза в неделю.

Если в поведении исследуемых объектов есть сезонность, попробуйте использовать значение метрики в аналогичный период прошлого сезона. Примеры сезонных явлений:

- разное количество посетителей в будни и на выходных (недельная сезонность);
    

- увеличение спроса на мандарины и новогоднюю атрибутику в декабре (годовая сезонность);
    
- многие сорта яблонь обильно плодоносят раз в два года.
    

Можно использовать данные, полученные во время эксперимента, если наше воздействие на них не влияет. Например, это могут быть данные о погоде, если эксперимент не изменяет климат и не приводит к погодным аномалиям.

На картинке ниже проиллюстрировано, в какие периоды времени относительно эксперимента какие метрики считаются:

![](https://habrastorage.org/r/w1560/getpro/habr/upload_files/cc6/927/e21/cc6927e21c594e5af321b693b30bdf03.png)

В качестве ковариаты могут использоваться любые характеристики исследуемых объектов, не зависящие от эксперимента. Для пользователей онлайн-магазина это могут быть количество дней с первой покупки, город проживания, рост, средний балл в аттестате, месяц рождения и так далее. Все эти признаки могут как-то коррелировать с целевой метрикой. Чтобы получить максимальный результат, нужно обучить на этих данных модель машинного обучения, которая будет предсказывать значение метрики эксперимента, и использовать это предсказание как ковариату. Такой подход позволяет сильнее снизить дисперсию, но он сложнее в реализации.

### На чём оценивать Theta

В примерах выше мы оценивали параметр ![\theta](https://habrastorage.org/getpro/habr/upload_files/8a9/208/214/8a9208214db638b0d77340c37db9fd03.svg) на объединённых данных контрольной и экспериментальной групп. Может, лучше оценивать на данных только одной группы или на исторических данных?

Если размеры групп велики и эксперимент не приводит к сильному изменению корреляции ковариаты с целевой метрикой, то все предложенные способы оценки ![\theta](https://habrastorage.org/getpro/habr/upload_files/594/2a3/c61/5942a3c61fff3c4c6d33212d64289b36.svg) дадут одинаковые результаты.

Рассмотрим случай малых групп. Положим размеры групп равными 5. Увеличим размер эффекта, чтобы он был заметен на таких объёмах данных. Дополнительно будем генерировать данные популяции до эксперимента для оценки ![\theta](https://habrastorage.org/getpro/habr/upload_files/6cb/e8c/bae/6cbe8cbae28a4e48cd2a117b4432d769.svg) на исторических данных. Проведём синтетические А/А и А/Б тесты для четырёх способов оценки ![\theta](https://habrastorage.org/getpro/habr/upload_files/ac1/6ba/4bf/ac16ba4bf0eadc481bac74596a37ee82.svg) и построим распределения p-value.

Код

```

```

![](https://habrastorage.org/r/w1560/getpro/habr/upload_files/19f/d8a/46e/19fd8a46e2fde5d654a15dcf538a70ea.png)

При оценке ![\theta](https://habrastorage.org/getpro/habr/upload_files/f5c/616/fde/f5c616fdeb85ece74f75955af3eaa596.svg) на данных одной группы p-value для синтетических А/А-тестов распределено не равномерно, эти тесты некорректны. Так происходит из-за того, что на малых данных параметр ![\theta](https://habrastorage.org/getpro/habr/upload_files/aa7/566/d4f/aa7566d4fabc86db4f6ff2685a4b64b1.svg) переобучается под данные одной из групп и сильно снижает дисперсию CUPED-метрики в этой группе, случайные отклонения в другой группе с большей вероятностью приводят к ошибке первого рода.

Подход с оценкой параметра ![\theta](https://habrastorage.org/getpro/habr/upload_files/096/59b/542/09659b54250660fd97bb67177a925201.svg) на исторических данных имеет большую мощность, чем при оценке на объединении групп. Точность оценки ![\theta](https://habrastorage.org/getpro/habr/upload_files/ab9/551/e69/ab9551e69c7129b22dbb70f7da4a96a6.svg) на большом объёме исторических данных точнее, чем оценка по десяти точкам из эксперимента. Это позволяет получить преимущество.

Рассмотрим ситуацию, когда эксперимент приводит к изменению связи ковариаты с целевой метрикой. Вернём размер групп, равный 1000. Проведём численные эксперименты для крайних случаев: корреляция в экспериментальной группе увеличилась до 1 и уменьшилась до -1. Построим распределения p-value и сравним результаты с тестом Стьюдента.

Код

```

```

![](https://habrastorage.org/r/w1560/getpro/habr/upload_files/605/a97/ef1/605a97ef18b3d3c00a98689a31acd6a5.png)

При увеличении корреляции чувствительность критериев для обоих способов оценки ![\theta](https://habrastorage.org/getpro/habr/upload_files/419/561/ad8/419561ad8a3a168ee7b3cd2c4bde2b0b.svg) увеличивается, подход с оценкой ![\theta](https://habrastorage.org/getpro/habr/upload_files/38c/e9c/309/38ce9c3099d9d77c961820220ffb4498.svg) по историческим данным немного проигрывает в мощности. При уменьшении корреляции до -1 чувствительность критериев уменьшается. Причём, при оценке ![\theta](https://habrastorage.org/getpro/habr/upload_files/c88/a45/e01/c88a45e0181a6512c8b3703d9712d9a1.svg) по историческим данным мощность хуже, чем для теста Стьюдента, а при оценке ![\theta](https://habrastorage.org/getpro/habr/upload_files/7b5/c2b/b5f/7b5c2bb5fc817c41f3669ba824d92006.svg) по данным эксперимента примерно совпадает с мощностью теста Стьюдента.

Итого, если размеры групп достаточно велики, лучше оценивать ![\theta](https://habrastorage.org/getpro/habr/upload_files/cac/b46/48c/cacb4648c43e91ec2c33dd7a4f728b83.svg) на объединённых данных контрольной и экспериментальной групп. Если размеры групп малы, то оценка ![\theta](https://habrastorage.org/getpro/habr/upload_files/3de/788/9cf/3de7889cfe7210370a293ccc8b89fad4.svg) на исторических данных может дать лучшее качество.

Обратим внимание, что для оценки ![\theta](https://habrastorage.org/getpro/habr/upload_files/30b/be0/0c5/30bbe00c5bb49bb70e9523685fd6e4f7.svg) по историческим значениям нужно использовать актуальные данные. С течением времени связь между ковариатой и целевой метрикой может меняться. Например, когда онлайн-магазин только запустился, постоянных клиентов ещё нет, и корреляция метрики во время эксперимента с метрикой до эксперимента, используемой в качестве ковариаты, будет около нуля. Через год появятся постоянные клиенты и корреляция увеличится. Оценив ![\theta](https://habrastorage.org/getpro/habr/upload_files/656/3aa/6cf/6563aa6cf9fecedda47f60d6539c4179.svg) на неактуальных данных, мы получим неверную оценку для текущего момента и не достигнем максимального эффекта от применения CUPED.

## Бинарные метрики

Периодически сталкиваемся с вопросом, можно ли использовать CUPED для бинарных метрик? Если нужно повысить чувствительность статистического критерия для проверки гипотезы о равенстве средних значений бинарных метрик, мы не видим причин не применять CUPED. Покажем на примере, что для бинарных метрик CUPED работает.

Изменим функцию генерации данных, чтобы она возвращала данные со значениями 0 и 1. Проведём симуляции экспериментов и построим распределения p-value.

Код

```

```

![](https://habrastorage.org/r/w1560/getpro/habr/upload_files/e0f/0d6/a7a/e0f0d6a7ac764fb281c3e50936123dc4.png)

CUPED корректно работает для бинарных метрик и имеет большую мощность по сравнению с тестом Стьюдента.

## Противоречивые результаты

Представим: оценка с CUPED говорит, что значимых отличий нет, а тест Стьюдента — значимые отличия есть. Возможна ли такая ситуация, или мы допустили ошибку в вычислениях? Что делать, кому верить?

Если критерий F более мощный, чем критерий G, это не значит, что при наличии эффекта критерий F обнаруживает значимые отличия всегда, когда критерий G обнаруживает значимые отличия. При наличии эффекта более мощный критерий в среднем обнаруживает значимые отличия чаще.

![](https://habrastorage.org/r/w1560/getpro/habr/upload_files/d76/8a8/426/d768a8426336e814ed8cdd1d546d0161.png)

Покажем, что применение двух разных критериев, один из которых более мощный, может привести к любому исходу. Проведём 1000 синтетических А/Б тестов и оценим их с помощью CUPED и теста Стьюдента. Построим полученные значения p-value на графике.

Код

```

```

![](https://habrastorage.org/r/w1560/getpro/habr/upload_files/594/123/a51/594123a51a1655e43ed095a3549a25e5.png)

На графике выше синими точками отмечены ситуации, когда критерии дают одинаковые ответы о значимости отличий, а красными — разные. Видно, что бывают ситуации, где CUPED ошибается, а тест Стьюдента – нет, и наоборот.

Для оценки эксперимента нужно использовать критерий с лучшими вероятностями ошибок. Оценить вероятности ошибок можно с помощью синтетических тестов на исторических данных. Про синтетические тесты можно почитать в статье [Проверка корректности А/Б тестов](https://habr.com/ru/company/X5Tech/blog/706388/).

Если вы очень хотели увидеть эффект в эксперименте, но выбранный критерий показывает отсутствие значимых отличий, то, перебирая различные критерии и способы обработки данных, рано или поздно вы найдёте критерий, который покажет значимые отличия. Но такой подход увеличивает вероятности ошибок.

## Итоги

Вспомним основные идеи статьи:

- CUPED позволяет повышать чувствительность А/Б тестов с помощью дополнительных данных, которые объясняют часть дисперсии целевой метрики.
    
- Снижение дисперсии доказано теоретически.
    
- Если размеры групп достаточно велики, лучше оценивать ![\theta](https://habrastorage.org/getpro/habr/upload_files/818/e27/d85/818e27d85dafabf2395e728b53312534.svg) на объединённых данных контрольной и экспериментальной групп. Если размеры групп малы, то оценка ![\theta](https://habrastorage.org/getpro/habr/upload_files/452/03a/b42/45203ab42bd4b416647fd02c19285f16.svg) на исторических данных может дать лучшее качество.
    
- CUPED работает для бинарных метрик.
    
- Результаты разных критериев могут быть противоречивы. Нужно использовать критерий с лучшими вероятностями ошибок.