---
tags:
  - data
link: https://m.vk.com/@kontur_student-odin-mnogorukii-bandit-protiv-vseh-ab-testov
data_type:
  - AB tests
---
_Продолжаем вытаскивать из нашей внутренней сети статьи наших разработчиков. В этот раз покажем вам статью [Алексея Шестакова](https://vk.com/id176107190) про замену А/Б-тестам._

_Тестирование — одна из важных частей разработки. Благодаря тестам, продукт можно улучшить, избежать боли пользователей и сделать почти идеально._

![Один многорукий бандит против всех А/Б-тестов, изображение №1](https://sun9-80.userapi.com/impg/c854416/v854416081/2452af/bvkqJOeskZg.jpg?size=807x489&quality=96&sign=7444cac0d87e76f02d938e1523d35016&type=album)

Когда хочется добавить в продукт новую фичу, поменять имеющуюся или изменить формулу построения рекомендации, обычно вспоминают про классические А/Б-тесты.

Как они проводятся? Пользователей делят на две группы, придумывают метрику, показывают каждой группе свою версию фичи. Через некоторое время по метрике оценивают, какая версия лучше. Более подробно останавливаться на А/Б-тестах я не буду.

Подход стандартный, более-менее понятный, подробно описан, но не лишен проблем:

- требуется ручная поддержка процесса: нужно запускать исследования, рассчитывать пороги принятия решения. Нужен человек, который будет следить за процессом.
- предполагается, что поведение пользователей не меняется со временем.
- часть пользователей будет видеть неудачные варианты фичи больше времени, чем могли бы.

Существует другой, менее известный подход, согласно которому можно просто зарелизить фичу, а выбор варианта фичи для показа предоставить алгоритму. Более того, можно даже учитывать изменения предпочтений пользователей со временем.

О чём же речь? Знакомьтесь:

## Многорукие бандиты

Идея довольно простая. Представим игральный автомат типа "однорукий бандит": кидаешь монетку, дёргаешь ручку и иногда (с заданной вероятностью, распределением, вероятностным правилом или законом) получаешь выигрыш, большой или не очень, — всё зависит от того, насколько жаден владелец автомата.

- "Многорукий бандит" — это математический аналог, придуманный по образу и подобию реального однорукого прототипа и отличается от него немногим — у него просто несколько рук (или — ручек).
- Каждая ручка обладает своими свойствами (вероятностным законом), и какая-то ручка работает лучше, и если бы ты знал с самого начала про эту ручку, то в среднем выигрывал бы чаще и больше.
- Ручки на вид все одинаковые и заранее (пока не дёрнешь за них) неизвестно, какая ручка как себя ведёт.

Если переформулировать в терминах веб-разработки: когда выпускаешь новый вариант фичи или меняешь формулу ранжирования результатов, ты так же не знаешь, насколько новая фича будет полезна пользователю, и какой вариант фичи, формулы ему показать.

## Для чего многорукий бандит в продакшене

Тут всё просто: релизишь новый вариант фичи — у многорукого бандита появляется новая ручка. Каждый раз, когда пользователь обращается за фичей, алгоритм многорукого бандита принимает решение, какой вариант фичи показывать пользователю (или формулу, или какой алгоритм рекомендации применять).

Когда алгоритм многорукого бандита понимает, что тот или иной вариант фичи чаще даёт лучший результат, он начинает показывать его всё чаще. Плохие варианты фичи показываются пользователю всё реже.

В зависимости от постановки задачи может так случиться, что вариант фичи вдруг или со временем начинает нравиться пользователям больше, чем раньше. В таком случае алгоритм должен будет плавно переключиться на использование этого варианта фичи.

Итак, в отличие от А/Б-тестов, применение многоруких бандитов позволяет:

- автоматически вводить фичу в строй при успехе фичи у пользователей,
- автоматически реагировать на изменения предпочтений пользователей,
- автоматически переключиться со "сломанного" варианта фичи при падении части инфраструктуры.
- без подготовки проводить как эксперимент, так и процедуру оценки результата.

Алгоритм многорукого бандита балансирует между двумя задачами:

- Эксплуатация (exploitation) — извлечение прибыли из текущих знаний о ручках.
- Исследование (exploration) — добыча новых знаний: может быть, есть такая ручка, которая приносит больше выигрыша? Какая-то ручка вдруг заработала лучше?

Такая дилемма типична для задач из раздела машинного обучения — **Обучение с подкреплением (Reinforcement learning)**.

## Среда обитания многорукого бандита

Для того чтобы посмотреть, как работает многорукий бандит, нам нужна модель его "рук". Например, если мы используем многорукое чудище для того, чтобы показывать разные версии сайта. А за "награду" возьмем конверсию — процент посетителей, который остался на нашем сайте после показа конкретной версии сайта.

Мы заранее не знаем, какие факторы могут повлиять на то, что пользователь останется или уйдёт от нас. Но мы можем с некоторой долей уверенности предположить, что таких факторов много.

В такой постановке мы можем воспользоваться Центральной предельной теоремой, а именно — тем фактом, что сумма множества случайных факторов (величин) приводит к появлению нормального распределения.

Тогда мы можем смоделировать выигрыш от использования "руки" многорукого бандита измерением (выборкой) нормально распределённой случайной величины с заданными параметрами дисперсии и матожидания. При этом разными для каждой из рук.

Но на самом деле это всё допущение, никаких гарантий, что распределение в конкретной задаче будет нормальным, нет. Но это не запрещает использовать многоруких бандитов в задаче.

![Статьи Вконтакте плохо вставляют код, поэтому картинка](https://sun9-65.userapi.com/impg/c857728/v857728081/209ca6/pZArJTd4w3g.jpg?size=807x726&quality=96&sign=0c5d91055b3269cb7d5a9e3d266e007b&type=album)

Статьи Вконтакте плохо вставляют код, поэтому картинка

![Один многорукий бандит против всех А/Б-тестов, изображение №3](https://sun9-58.userapi.com/impg/c854416/v854416081/2452b7/Kkg1NBA2BEw.jpg?size=791x565&quality=96&sign=70753de21f8833ad14a661dd7bba57a3&type=album)

![Один многорукий бандит против всех А/Б-тестов, изображение №4](https://sun9-80.userapi.com/impg/c857728/v857728081/209cd3/JCWhkTZvRVQ.jpg?size=807x119&quality=96&sign=72148a7b7e5ef313b770f142c974afd4&type=album)

![Один многорукий бандит против всех А/Б-тестов, изображение №5](https://sun9-53.userapi.com/impg/c854416/v854416081/2452bf/p6HI5I_gIm0.jpg?size=791x565&quality=96&sign=7de3d144d2945b84c754b48f22f9b7fb&type=album)

## Какие модели бандитов бывают?

В зависимости от решаемой задачи существует выбор модели бандита. Среди самых популярных:

- Multi-armed bandit — каждая ручка задаётся плотностью вероятности награды.
- Binary multi-armed bandit (Benulli multi-armed bandit) — награда у всех ручек фиксированная и одинаковая. Но выдаётся награда, только с вероятность p, различной для каждой ручки. C вероятностью 1 - p награда не выдаётся.
- Restless multi-armed bandit — каждая ручка может со временем менять своё поведение (плотностью распределения вероятности).
- Sleepy multi-armed bandit — ручки могут пропадать и возникать снова, становиться и переставать быть доступными в конкретных раундах.
- Mortal multi-armed bandit — ручки исчезают и больше не возвращаются.
- Contextual Multi-Armed Bandits — награда ручки зависит от того кто, ей пользуется, например, от конкретного пользователя.

## Простые алгоритмы

- **Greedy ("Жадный")** — алгоритм выбирает самую первую ручку, которая даёт любой положительный результат, и использует её. Каких-то дополнительных исследований алгоритм не производит.
- **100% Исследователь** — алгоритм просто выбирает случайную ручку из всех доступных.

Всё просто и не работает, и не решает задачу. Но это просто крайности. Идём дальше.

### ε-greedy (эпсилон "жадный")

Бандит как бы подбрасывает необычную монетку каждый раз, когда нужно принять решение. Монетка отличается от обычной тем, что падает на одну сторону с вероятностью ε, а на другую — с вероятностью 1 - ε.

В зависимости от того, в какую сторону упала монетка, мы принимаем решение, дергаем ту ручку, про которую мы знаем, что она приносит в среднем больше выигрыша, чем все остальные, либо дергаем любую другую ручку и записываем, сколько выигрыша она принесла.

Лучшая ручка выбирается довольно просто, через обыкновенное среднее:

![Один многорукий бандит против всех А/Б-тестов, изображение №6](https://sun9-75.userapi.com/impg/c854416/v854416081/2452d2/wyChv-CVR6o.jpg?size=807x138&quality=96&sign=b6d9db7594f0ab9c1d13d191de228de1&type=album)

где N — число экспериментов,  
X1,X2 … Xn — награды за 1-е, 2-е…энное использование ручки.

Заметим, что Жадный и 100% Исследователь получаются, когда ε выставляется в 0.0 и в 1.0.

Откуда взялось название ε-greedy?

**"Жадными"** в информатике называются алгоритмы, принимающие решение без оглядки на будущее, исходя из текущей ситуации. ε-greedy в данном контексте означает, что с вероятностью ε будет принято "жадное" решение дёрнуть самую лучшую на данный момент ручку, даже если на самом деле лучшая ручка другая, просто другие ручки мы недостаточно исследовали.

### Реализация

![Один многорукий бандит против всех А/Б-тестов, изображение №7](https://sun9-63.userapi.com/impg/c857728/v857728081/209d19/2HnO6TKbdFw.jpg?size=807x763&quality=96&sign=1d9a37a15ab8e4e74c9b6faeb1b20a6f&type=album)

![Один многорукий бандит против всех А/Б-тестов, изображение №8](https://sun9-80.userapi.com/impg/c857728/v857728081/209d22/sS1v9nK9Q2Y.jpg?size=807x292&quality=96&sign=eb391dd1426eb789dee96f03e23644d1&type=album)

![Один многорукий бандит против всех А/Б-тестов, изображение №9](https://sun9-8.userapi.com/impg/c857728/v857728081/209d2b/xmyBlOvmvb8.jpg?size=807x538&quality=96&sign=c8d05496aab87ebd8d562aa61df1ceca&type=album)

Попробуем выставить ε = 1.0 (бандит в 100% случаев будет заниматься исследованием).

![Один многорукий бандит против всех А/Б-тестов, изображение №10](https://sun9-31.userapi.com/impg/c857728/v857728081/209d34/Vj_iBIrU5_k.jpg?size=807x66&quality=96&sign=13f01ca24e9b78a7fbef280371534909&type=album)

![Один многорукий бандит против всех А/Б-тестов, изображение №11](https://sun9-73.userapi.com/impg/c854416/v854416081/2452dc/cbp2xR9WuDY.jpg?size=807x286&quality=96&sign=ba3a518e82d52882da09f0ba415f647b&type=album)

Все ручки исследуются в равной пропорции.

Примерно так же может выглядеть проведение А/Б-теста в четырёх вариантах с равным разделением аудитории. Что показывает неэффективность А/Б-тестирования. Многорукий бандит может найти лучшии вариант фичи гораздо быстрее, чем человек примет решение, что будет показано далее.

Попробуем выставить ε = 0.0 — теперь сделаем бандита на 100% жадным.

![Один многорукий бандит против всех А/Б-тестов, изображение №12](https://sun9-14.userapi.com/impg/c857728/v857728081/209d51/Dpup5FA6FkQ.jpg?size=807x72&quality=96&sign=1cb2124867b9601776ce21798a2725a9&type=album)

![Один многорукий бандит против всех А/Б-тестов, изображение №13](https://sun9-47.userapi.com/impg/c854416/v854416081/2452e6/3L0af59z408.jpg?size=807x286&quality=96&sign=562d9bf81b0c06048a00942b4abf4fa5&type=album)

Как и ожидалось, выбралась самая первая ручка, дальше исследования не производятся.

Попробуем выставить ε = 0.5. Самая лучшая ручка найдена, но исследования занимают 50% запусков.

![Один многорукий бандит против всех А/Б-тестов, изображение №14](https://sun9-78.userapi.com/impg/c857728/v857728081/209d5a/CU4aRnBMIX0.jpg?size=807x69&quality=96&sign=41176ccc628e2b7e1140c9636c029d8c&type=album)

![Один многорукий бандит против всех А/Б-тестов, изображение №15](https://sun9-49.userapi.com/impg/c854416/v854416081/2452f0/idPfNoot3Ts.jpg?size=807x286&quality=96&sign=4d9ef304a8f51e2a4e0d1db571655628&type=album)

![Один многорукий бандит против всех А/Б-тестов, изображение №16](https://sun9-54.userapi.com/impg/c857728/v857728081/209d63/SkjmrYxzoUw.jpg?size=807x69&quality=96&sign=d158d486c7b55835fb55c060ab5076be&type=album)

![Один многорукий бандит против всех А/Б-тестов, изображение №17](https://sun9-78.userapi.com/impg/c854416/v854416081/2452fa/St3342WTT1w.jpg?size=807x286&quality=96&sign=6bde5646012a2a9cbfd6ab2cf3acc6c7&type=album)

![Один многорукий бандит против всех А/Б-тестов, изображение №18](https://sun9-17.userapi.com/impg/c857728/v857728081/209d6c/Hlb8bkgHRLs.jpg?size=807x77&quality=96&sign=dc90a243cd345a647e0fa1e4a54220cd&type=album)

![Один многорукий бандит против всех А/Б-тестов, изображение №19](https://sun9-47.userapi.com/impg/c854416/v854416081/245304/CTSmeZMc5z0.jpg?size=807x286&quality=96&sign=cc2e289e036f18a5959260331a1c5ab9&type=album)

Попробуем выставить ε = 0.05.

![Один многорукий бандит против всех А/Б-тестов, изображение №20](https://sun9-19.userapi.com/impg/c857728/v857728081/209d75/MAO8iHIuQ1I.jpg?size=807x67&quality=96&sign=78516e89529c993f61ae76e062e209c7&type=album)

![Один многорукий бандит против всех А/Б-тестов, изображение №21](https://sun9-24.userapi.com/impg/c854416/v854416081/24530e/5OplDxd0WI0.jpg?size=807x286&quality=96&sign=566027dea31b3049e5298af5b9ef2737&type=album)

Теперь бандит сходится к лучшей ручке медленно, но при этом в конце концов доля исследований фиксированная. Хорошо или это плохо, зависит от задачи: если ручки меняют своё поведение со временем, то данное свойство желаемо.

## Выводы по ε-greedy

Несмотря на простоту и вроде бы адекватность алгоритма, у него есть проблемы:

1. Мы храним значения всех наград, что затратно.
2. Если поведение ручек меняется со временем, алгоритм не сможет адекватно среагировать — среднее довольно нечувствительно.
3. После большого числа использования ручек, когда поведение каждой ручки уже понятно, алгоритм продолжает исследование и получает заведомо плохие награды, чего мог бы не делать.

Что можно сделать:

- С первым: заменить среднее, например, на скользящее среднее.
- Со вторым: заменить среднее на более чувствительную вещь, например, на медиану. Скользящее среднее также поможет с первой проблемой.
- C третьим: уменьшать вероятность ε на исследование со временем. А при релизе новой фичи — повышать.

Это уже будут другие варианты алгоритмов.

Идея в том, чтобы уменьшать долю исследований, отразилась в Aлгоритме UCB1.

## Оптимизм перед неизвестностью — Алгоритм UCB1

Вообще можно не кидать монетку для того, чтобы выбрать, что же мы хотим делать, а оценить, насколько больше может быть выигрыш. Мы уже несколько раз дёргали ручку и уже имеем оценку T среднего выигрыша с конкретной ручки. Если ручки со временем не меняют своего поведения, то с каждым использованием ручки надежды недооценить должно становиться всё меньше и меньше.

Формула оценки выводится из неравенства Хёфдинга:

![Один многорукий бандит против всех А/Б-тестов, изображение №22](https://sun9-71.userapi.com/impg/c854416/v854416081/245321/dTCC-2qb6io.jpg?size=807x100&quality=96&sign=e499d3ada7800ef0eaf408c47bf8587b&type=album)

где, g ≥ 0.

В контексте задачи неравенство ограничивает разницу между посчитанным по первым N использованиям конкретной ручки многорукого бандита оценки среднего выигрыша (T) и реального значения среднего E[T] после бесконечного числа попыток.

Вероятность:

![Один многорукий бандит против всех А/Б-тестов, изображение №23](https://sun9-69.userapi.com/impg/c854416/v854416081/245361/oAmpAgUnito.jpg?size=807x144&quality=96&sign=9b172a227cb0b5809b8f715413e21601&type=album)

можно трактовать как вероятность превысить выбранный порог g.

Как выбрать такой порог и как задать вероятность p?

![Один многорукий бандит против всех А/Б-тестов, изображение №24](https://sun9-5.userapi.com/impg/c854416/v854416176/2495fb/klsJJ9GcMcc.jpg?size=181x32&quality=96&sign=2f97740a59b5988462a0c1aad5bdc627&type=album)

![Один многорукий бандит против всех А/Б-тестов, изображение №25](https://sun9-3.userapi.com/impg/c854416/v854416176/249602/5bOV6txWF-s.jpg?size=147x59&quality=96&sign=efcb3d50cc14ac9abe886fed0adb13b5&type=album)

![Один многорукий бандит против всех А/Б-тестов, изображение №26](https://sun9-42.userapi.com/impg/c854416/v854416176/249609/Eo7kvQen3a0.jpg?size=165x68&quality=96&sign=dffa0608bbd8709c58c6c1b7c1d5f1cf&type=album)

Авторы статьи [2] придумали эвристику:

![Один многорукий бандит против всех А/Б-тестов, изображение №27](https://sun9-13.userapi.com/impg/c854416/v854416176/249610/PIb0uwdPBb4.jpg?size=314x94&quality=96&sign=daf964fb9f51bbf0cfafd3038ac8f49f&type=album)

Подставим в выражение р и получим формулу из статьи:

![Один многорукий бандит против всех А/Б-тестов, изображение №28](https://sun9-24.userapi.com/impg/c854416/v854416176/249617/adu_hMXmSlc.jpg?size=569x250&quality=96&sign=dab23c792feefcc252812603a81cbdc9&type=album)

Так мы можем оценить надежду по улучшению t-й ручки бандита.

Если мы хотим получить большую скорость сходимости и больше исследований на первых шагах работы алгоритма, то мы можем использовать другую эвристику, взяв не -4, а большее число. Но можно поступить проще, введя константу с, — результат тот же с точностью до внесения под корень.

![Один многорукий бандит против всех А/Б-тестов, изображение №29](https://sun9-59.userapi.com/impg/c854416/v854416176/24961f/QkzrGU0kSQ0.jpg?size=605x250&quality=96&sign=089a4e9dded1ec9de959fd3141adb200&type=album)

где c > 0 — константа оптимистичности: чем больше она, тем больше мы оптимистичны,  
Na — сколько раз обращались к бандиту за решением,  
Nt — сколько раз обращались к конкретной t-ой ручке бандита.

Если же Nt = 0, т.е. ручку бандита ещё никогда не дёргали, то ручка просто считается приоритетнее всех, уже однажды опробованных.

Теперь можно выбрать ручку, рассчитав формулы для каждой из них, и выбрать ту, что даёт максимум:

![Один многорукий бандит против всех А/Б-тестов, изображение №30](https://sun9-9.userapi.com/impg/c854416/v854416176/249627/K2u4jSYPxVc.jpg?size=735x100&quality=96&sign=60ba2571ec28e5b77432f8a3337001b3&type=album)

![Один многорукий бандит против всех А/Б-тестов, изображение №31](https://sun9-30.userapi.com/impg/c854416/v854416176/249660/9uIfE_4rdZA.jpg?size=907x1080&quality=96&sign=ddc26b664b0e38ecc0dabdc221e15e14&type=album)

![Один многорукий бандит против всех А/Б-тестов, изображение №32](https://sun9-69.userapi.com/impg/c854416/v854416176/24966a/991SwC07l0A.jpg?size=807x286&quality=96&sign=217c0be51197cbf7921195b09966ec5f&type=album)

Но на графике не видна проблема, которая может возникнуть на практике. Если ручка обладает большой дисперсией, то многорукий бандит может сначала сойтись к ручке, имеющей меньшее матожидание и меньшую дисперсию, и лишь потом, через продолжительное время, сойтись к нужной, так как исследование будет производиться заметно медленнее.

Попробуем воспроизвести такую ситуацию:

![Один многорукий бандит против всех А/Б-тестов, изображение №33](https://sun9-1.userapi.com/impg/c857728/v857728176/210238/-AY5Vyl86Dk.jpg?size=807x431&quality=96&sign=af5ed45cc6b5b13b87f500ea420e0f72&type=album)

![Один многорукий бандит против всех А/Б-тестов, изображение №34](https://sun9-16.userapi.com/impg/c854416/v854416176/249672/uPfZDxKtEuY.jpg?size=791x534&quality=96&sign=46828d4b8f1361447ad4ff362f30ef6b&type=album)

Теперь у нас лучшая ручка обладает большей дисперсией выигрыша, и есть ручка с меньшим средним выигрышем, но и с меньшей дисперсией.  
Теперь алгоритм может вести себя некорректно.

![Один многорукий бандит против всех А/Б-тестов, изображение №35](https://sun9-70.userapi.com/impg/c857728/v857728176/210241/E77X3B4PNoA.jpg?size=807x72&quality=96&sign=07f45acbfa79cfc75c75540298df10e6&type=album)

![Один многорукий бандит против всех А/Б-тестов, изображение №36](https://sun9-66.userapi.com/impg/c854416/v854416176/24967c/claRHFlxYio.jpg?size=807x286&quality=96&sign=14da63919dfc5627b5c66b9e828ceb7d&type=album)

Что можно с этим сделать?

Больше исследовать, настроить константу c — нам нужно больше оптимизма.

### Выводы по UCB1

- Если бандит не настроен, то может сойтись **сначала** не к самой лучшей руке и лишь потом, очень медленно, к лучшей.
- Сочетает быструю скорость сходимости и не пытается исследовать неперспективные ручки.
- Не подходит, если ручка меняет свои свойства.

## Что дальше?

Можно ли сделать ещё лучше?

Да, если мы **в какой-то степени** знаем свойства ручек **заранее**.

Другим словами, у нас должны быть априорные знания, а в случае распределений — априорные распределения. Подход, в котором вероятность рассматривается как степень незнания, называется Байесовским.

Используя формулу Байеса, мы можем учитывать полученные выигрыши, тем самым уточняя знания о руках многорукого бандита. Мы также можем ограничиться конкретным видом распределения, это тоже априорное знание.

Но это повод для другой статьи.

## Выводы

В статье я старался показать, что автоматический подход:

- не сложен для понимания,
- не сложен в реализации,
- имеет преимущества перед А/Б-тестами.

Я надеюсь, статья послужит мотиватором в использовании многоруких бандитов в продуктовой практике как замена А/Б-тестам.