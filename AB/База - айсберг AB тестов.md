---
link: https://habr.com/ru/companies/sbermarket/articles/774608/
tags:
  - data
data_type:
  - AB tests
source: habr
author: Mosin
---
[[Бутстрап швейцарский нож аналитика в AB-тестах]]
[[Линеаризация - зачем и как укрощать ratio-метрики в AB-тестах]]

Если вы по кусочкам и фрагментарно изучаете разные аспекты и тонкости A/B-тестирования, но множество концепций и идей не ложатся в единую систему, то это статья для вас.

Предлагаю разобрать структуру A/B-тестов сверху вниз. Пройдем по основным этапам от наблюдаемой разницы в целевой метрике до матрицы ошибок. Формализуем, систематизируем и идейно свяжем те концепции, которые стоят за экспериментами. Постараемся сформировать цельное представление об этой процедуре, обозначим, что эксперименты делают, чего не делают, как делают, в каком представлении работают с данными и метриками.

![](https://habrastorage.org/r/w1560/getpro/habr/upload_files/467/4fc/493/4674fc4938f550be6ea13f78015a7690.png)

❗**Основная идея**❗

Результаты A/B-тестов не показывают однозначно, стало ли что-то в продукте лучше или хуже. Статпроцедура, лежащая в основе экспериментов, контролирует уровень ошибки, ниже которого наблюдаемый эффект будет принят как нечто содержательное, хотя в действительности эффекта нет, а разница достигнута случайно.

Формально механика проведения A/B-тестов контролирует ошибку 1-го рода, что снижает долю релизнутых в продукт изменений без положительного влияния на бизнес.

---

### Итак, немного продуктовой мотивации

Продукт создается и развивается, чтобы удовлетворять потребность пользователя. Пользователь просматривает баннеры, кликает по кнопкам, пролистывает ленту до разных позиций, оформляет заказы и тратит деньги. По сути, пользователь оставляет **_сигналы_** в продукте, которые детектируются и складываются в логи.

Чаще всего, центральная сущность, на которую направлены усилия в экспериментах и на поведение которой хочется влиять, _—_  пользователь. Стандартным объектом рандомизации, который мы случайным образом распределяем в тестовую или контрольную группы, выступает также пользователь. Соответственно, и метрики в A/B-тестах в этом случае определяются в разрезе **пользователей**.

## 1. Верхушка айсберга

### 1.1 Метрики

Продуктовая метрика в обобщенном смысле — это единственное число, агрегата над сигналами пользователей из некоторого множества _U_. При этом в большинстве случаев она выражается через пару функций от пользователей следующим образом:

![](https://habrastorage.org/r/w1560/getpro/habr/upload_files/8f1/bcd/168/8f1bcd16818da9d13d563e78f4ceced4.png)

Немного про понятие функции

![](https://habrastorage.org/r/w1560/getpro/habr/upload_files/1b1/e99/db9/1b1e99db99d865bae37e13f955d33c56.png)

Три частных случая продуктовых метрик определяются через формулу выше.

- **Доли**_._ Бинарные сигналы, например, _конверсия в покупку_ или _retention_ _rate_. Подразумевается, что пользователь соответствует определенному критерию, сделал какое-то действие. В общем случае попал в некоторое подмножество _S_ множества _U:_
    

![](https://habrastorage.org/r/w1560/getpro/habr/upload_files/521/bb3/3b9/521bb33b9a5c82af110b62db86b2a4a2.png)

Еще немного про символы

![](https://habrastorage.org/r/w1560/getpro/habr/upload_files/1df/eb2/638/1dfeb2638d4b7bbe37e2729013909dd2.png)

-  **Средние** **метрики пользователей**. Численные сигналы, например, _среднее число добавленных товаров в корзину на юзера_ или _ARPU_:
    

![](https://habrastorage.org/r/w1560/getpro/habr/upload_files/e1e/cff/be3/e1ecffbe3a3a00d8aea43f6ebdba994a.png)

-  **Ratio-метрики**. Отношение двух сумм пользовательских сигналов, например, _средний чек_, _средняя длина сессии_ или _CTR_:
    

![](https://habrastorage.org/r/w1560/getpro/habr/upload_files/335/0dc/900/3350dc900b1687496053870bc244587c.png)

Ratio-метрика — это метрика с **зависимыми наблюдениям**. Например, если в A/B-тесте сагрегировать сигналы по заказам, чтобы посчитать средний чек, то несколько заказов могут быть сделаны одним пользователем. Получается ratio-метрику еще можно определить через сигналы объектов, которые относятся к пользователям как _N к 1_ и значения которых в рамках одного пользователя можно считать скорелированными. Такие метрики нельзя оценивать стандартными статкритериями, которые требуют **независимости наблюдений**:

![](https://habrastorage.org/r/w1560/getpro/habr/upload_files/7c7/b82/8c6/7c7b828c6b4850089ac5959264bdd493.png)

При дизайне новых метрик или чтобы отделять одну метрику от другой, удобно думать о том, на каких сигналах и с какого этапа продуктовой воронки они собираются.

### 1.2 Воронка

Модель продукта или отдельного продуктового направления хорошо воспринимается в виде воронки. Она позволяет описать путь пользователя через различные этапы, на которых пользователи оставляют сигналы, а продуктовые команды реализуют экспериментальные механики.

![Воронка продукта в СберМаркете](https://habrastorage.org/r/w1560/getpro/habr/upload_files/79c/a6a/098/79ca6a0982d4030d1f0953920e86e7db.jpg "Воронка продукта в СберМаркете")

Воронка продукта в СберМаркете

Метрики конверсий отражают движение пользователей вниз по воронке, указывая, сколько пользователей переходит с одного этапа на другой. Средние пользовательские метрики измеряют горизонтальную активность на отдельных этапах воронки, оценивая действия пользователей на одном и том же уровне.

Если за период всего эксперимента интересует не единственный факт перехода пользователей на следующий этап воронки, выраженный конверсией, а сколько раз они суммарно были на одном этапе и суммарно переходили на следующий, то это ratio-метрики. Такие метрики, в частности, отвечают на вопрос — как хорошо новый дизайн побуждает пользователей каждый раз переходить на следующий этап, т.е. сумма показов делится на сумму кликов-переходов.

При выборе приемочных метрик самыми чувствительными для обнаружения эффекта являются те, которые находятся на этапе воронки, где реализована экспериментальная механика. Эти метрики — индикаторы **непосредственного** изменения поведения пользователей от экспериментального воздействия. Например, если поменять дизайн кнопки в каталоге товаров, то число _кликов на юзера_ или _кликабельность кнопки_ будут более чувствительны, чем _ARPU_ или _средний чек._ После того как пользователь увидит новый дизайн кнопки, ему придется пройти много этапов в приложении, чтобы сконвертироваться в итоговую трату денег, до которой он может и не дойти.

После агргеации сигналов по пользователям с различных этапов воронки получается датасет, ключом которого является пользователь. Для каждого известна группа и рассчитаны сигналы, которые имеют распределения для соответствующих экспериментальных групп. С ними и погружаемся глубже на следующий уровень айсберга, где эти сигналы подвергаются преобразованиям.

![Распределение пользовательских сигналов по группам](https://habrastorage.org/r/w1560/getpro/habr/upload_files/d07/8aa/0ba/d078aa0ba35ee5b160c1dbb0059d8873.png "Распределение пользовательских сигналов по группам")

Распределение пользовательских сигналов по группам

## 2. Там, где еще плавает рыба

Пользовательские сигналы можно преобразовывать модными методами для увеличения чувствительности метрик к обнаружению эффекта. К ним можно отнести CUPED, линеаризацию, стратификацию, бакетный метод и др. Каждый метод достоин отдельной подробной статьи, поэтому в этой укажу только мотивацию их применения.

Главная идея —  **компенсация** «изъянов» в полученных данных и ограничений в статпроцедуре:

- **Линеаризация** преобразует _ratio-метрику_ с зависимыми наблюдениями в среднюю поюзерную с независимыми, которую уже можно оценивать _t-тестом_.
    
- **CUPED** устраняет влияние предэкспериментального поведения пользователей на данные в текущем эксперименте. В том числе отчасти компенсирует смещение отбора (_selection bias_) в экспериментальные группы.
    
- **Бакетный метод**, как бутстрап для бедных, позволяет считать любые метрики. Он позволяет оценивать на статзначимость хоть ratio-метрики, хоть суммарные деньги в эксперименте, а не ARPU.
    

![Результат преобразований пользовательских сигналов](https://habrastorage.org/r/w1560/getpro/habr/upload_files/087/4a9/df4/0874a9df4605cf74451814925d84ba7b.png "Результат преобразований пользовательских сигналов")

Результат преобразований пользовательских сигналов

## 3. Бездна или там, где утопают мальки

Получив значения метрик в тесте и контроле, почему бы не посмотреть на наблюдаемую разницу и заявить, что это — эффект от нашей новой механики.

С одной стороны, человек склонен реагировать на необычное, но случайное поведение метрик, и субъективно истолковывать его как нечто содержательное и реальное. С другой стороны, поведение пользователей неоднородно и обусловлено множеством неизвестных факторов, размер влияния которых невозможно оценить и контролировать. Эти факторы вносят случайные флуктуации и шум в данные.

Если в эксперименте принимать решение только по привлекательной наблюдаемой разнице в метриках, то легко выдать желаемое за действительное и спутать результат с воздействием неизвестных факторов. Если поторопиться и принять решение об отсутствии влияния, то существует шанс пропустить практически значимый эффект от экспериментального изменения. Получается, делая вывод только по наблюдаемой разнице в метриках, легко совершить **два вида ошибок**.

На дистанции такой подход, основанный на **эвристических выводах**_,_ обернется тем, что в продукт будет добавлено значительное количество фич-пустышек, а также будет пропущена часть действительно полезных механик. Итоговые результаты будут зависеть от выбранной субъективной стратегии принятия решения о наличии или отсутствии эффектов в A/B-тесте.

Поэтому используют **модель статистического вывода**. Подход хоть и не дает 100% гарантий в принятии правильных решений, но снижает вероятности совершения ошибок и основан уже на формальных математических принципах, а не на субъективной оценке.

Центральное место в этом подходе отведено **матрице ошибок**.

![Доли корректных и некорректных решений при разных подходах](https://habrastorage.org/r/w1560/getpro/habr/upload_files/40d/9b0/26d/40d9b026dfa364d34f93f08b1bd59a2f.png "Доли корректных и некорректных решений при разных подходах")

Доли корректных и некорректных решений при разных подходах

### 3.1 Матрица ошибок

Матрица ошибок (confusion matrix) старается устранить разрыв между субъективным восприятием и неизвестной объективной реальностью. Делает это она с помощью вероятностей (не)принять гипотезу, когда она на самом деле (не)верна.

![Матрица ошибок](https://habrastorage.org/r/w1560/getpro/habr/upload_files/b2b/9b6/466/b2b9b6466be7578a3a5dc53ffac06d08.png "Матрица ошибок")

Матрица ошибок

Однако, чтобы с ходу попытаться запомнить эти квадранты и оперировать ими, придется приложить некоторые усилия, поэтому предложу продуктово-ориентированный взгляд и выделю в матрице всего лишь одну сторону.

![Матрица ошибок с акцентами](https://habrastorage.org/r/w1560/getpro/habr/upload_files/705/f83/50e/705f8350e16359d8cb6c9debdec55f9f.png "Матрица ошибок с акцентами")

Матрица ошибок с акцентами

Внимание к одной стороне заключается в простом порядке мыслей.

Реальный эффект от нашей фичи может быть, а может и не быть вовсе, мы все равно этого _определенно_ не узнаем. Продуктовая команда тратит ресурсы и время на разработку фичи и дизайн эксперимента, при этом она априори делает положительные изменения, которые в итоге всегда хочется _принимать_. Когда эксперимент заканчивается, аналитик остается один на один с двумя стульями и оба, кстати, его:

- Вдруг эффекта от изменения в реальности **нет**. В таком случае, делая вывод о его наличии, хотелось бы ошибиться как можно в меньшем числе случаев. Это ошибка 1-го рода, ее контролируют с помощью **проверки нулевой гипотезы H0** статистическим критерием;
    
- С другой стороны, когда от нашего изменения эффект **действительно есть**, хочется, чтобы используемые метрики и статкритерий были достаточно чувствительны к обнаружению этого эффекта. Здесь на помощь приходит расчет **MDE/Sample size** и **Анализ мощности**.
    

Также для запоминания типов ошибок есть хорошая мнемоника:

> Когда мальчик прибегал в село и кричал «волки-волки», то сначала сельчане совершили ошибку первого рода, а затем  — второго.

### 3.2 Нулевая гипотеза

Проверка нулевой гипотезы — это инструмент, контролирующий уровень ошибки 1-го рода. Процент случаев, в которых продуктовая команда готова ошибаться, она определяет сама, ограничив порог принятия фич-пустышек выбранным уровнем значимости _alpha._

Нулевая гипотеза — это логический конструкт, воплощающий понятие о том, что на самом деле **в эксперименте ничего не произошло**, эффекта от нашего изменения нет, а любой эффект, который наблюдается в изменении метрик, обусловлен шумом и случайностью.

Эту идею удобно продемонстрировать на примере _t-теста_, так как его статистика — наблюдаемый эффект, выраженный разницей средних метрик пользователей в тестовой и контрольной группах.

Под нулевой гипотезой изначально предполагается, что эффекта нет, поскольку две наши группы извлечены из одной генеральной совокупности. При этом у нас есть шанс получить из нее как идентичные выборки, так и полностью непохожие друг на друга.  
Если бы мы могли «вытащить» из ГС бесконечно много таких пар выборок, считать разницы средних и построить по ним гистограмму, то они бы распределились нормально. Большая часть значений находилась около нуля, но попадались бы и пары выборок с очень большой разницей средних, как с положительным, так и с отрицательным эффектом.  
  
При дизайне эксперимента выбирается доля краевых, необычных случаев, когда мы готовы ошибиться и принять наблюдаемую разницу за реальный эффект, обычно 5%, — это и есть уровень значимости _alpha._

Проведя А/Б-тест, идейно можно «вытащить» из ГС только одну пару выборок, посчитать разницу средних и найти ее место среди остальных в обозначенной модели.

В экспериментах оценивают разные метрики, выраженные в деньгах, процентах, штуках, числе кликов и тд., и, чтобы для их всех иметь универсальное распределение, разницу средних делят на стандартную ошибку (_standard error_), получая метрику в безразмерной шкале.

Определив место наблюдаемого экспериментального случая в общем распределении, считаем общую долю таких и еще более выраженных случаев, это и будет _p-value._ Более формально, _p-value_ — это вероятность получить наблюдаемый или более выраженный эффект при условии, что верна нулевая гипотеза.

![Нулевая гипотеза для t-теста](https://habrastorage.org/r/w1560/getpro/habr/upload_files/e66/f58/17c/e66f5817c5d03282191e8ec956e877d6.png "Нулевая гипотеза для t-теста")

Нулевая гипотеза для t-теста

Критерий принятия решения достаточно прост:

- если _p-value ≤ alpha_, то отклоняем нулевую гипотезу _H0_, и заявляем, что эффект есть;
    
- если _p-value > alpha_, то у нас недостаточно оснований ее отклонить.
    

На данном этапе возникает большой соблазн интерпретации _p-value –_ чем он меньше, тем больше «уверенность», что _Н0_ неверна. Но, на самом деле, хоть _p-value_ равен _0.0499,_ хоть _3.6e-27,_ **вероятность ошибочно отклонить H0 остается на уровне _alpha_**_.  
_Так происходит из-за того, что для нулевой гипотезы _p-value_ распределены равномерно и вероятность случайно получить _p-value_ меньше _alpha_ равняется ее же значению.  

![Распределение p-value для нулевой гипотезы](https://habrastorage.org/r/w1560/getpro/habr/upload_files/986/e9b/89b/986e9b89b1cd8bf4cb791b7b5b0b91aa.png "Распределение p-value для нулевой гипотезы")

Распределение _p-value_ для нулевой гипотезы

### 3.3 Анализ мощности

Под мощностью подразумевается вероятность корректно отклонить нулевую гипотезу _H0_ и заявить, что эффект действительно есть.

Мощность зависит от числа наблюдений в имеющихся группах, модели эффекта, получаемого от экспериментального воздействия, и возможности статтеста этот эффект детектировать. В отличие от уровня значимости alpha, которую мы выбираем и фиксируем сами, мощность в конце эксперимента мы не контролируем.

Предварительный дизайн любого эксперимента включает в себя оценку размера выборок, который необходим для того, чтобы задетектить желаемый практический эффект, а в случае ограничения имеющегося трафика можно прикинуть минимальный детектируемый эффект (_MDE_) при заданных уровнях ошибок 1-го и 2-го родов.

![](https://habrastorage.org/r/w1560/getpro/habr/upload_files/cad/50b/df0/cad50bdf00b5d698b0e0cefabb951eef.png)

На Python под катом

```

```

Обе величины интерпретируются исключительно во время дизайна эксперимента, а после его начала, и особенно в конце, их информативность стремится к нулю, поскольку мы не контролируем каким будет наблюдаемый эффект в эксперименте. Соответсвенно и не знаем какая будет мощность.

На практике иногда встречается, что наблюдаемую разницу сравнивают с MDE, почему не стоит это делать хорошо и подробно рассказано [здесь](https://habr.com/ru/companies/lamoda/articles/728034/). Чтобы оценить в каких границах может находиться реальный эффект, наблюдаемую разницу задают доверительным интервалом.

Логичнее было бы из формул вывести мощность и определить ее значение для уровня alpha_, а_ вместо MDE подставить наблюдаемую в эксперименте разницу.  
Как считать мощность для любой метрики и для любого статкритерия с помощью бутстрапа можно узнать [здесь](https://habr.com/ru/articles/762648/).

![](https://habrastorage.org/r/w1560/getpro/habr/upload_files/02e/580/ca8/02e580ca8669bb7fd716a70de58a3ff5.png)

На Python под катом

```

```

Мощность в конце эксперимента редко может быть информативна когда у вас прокрасилась метрика, т.е. не принципиально мощность получилась 10% или 90%, вероятность что вы примите механику без эффекта останется на уровне _alpha_. В этом случае, продлевая эксперимент, чтобы набралась мощность, вы просто потратите время и имеющейся трафик.

Об этом можно думать следующим образом — эксперимент проводится не для того, чтобы принимать больше изменений с эффектом, а для того чтобы не принимать много изменений без практического эффекта. По сути вся процедура А/B-тестирования это трейд-офф между длительностью проведения и точностью полученных результатов.

С другой стороны, получив серые результаты в конце эксперимента, если наблюдаемая разница в метриках выглядит привлекательно с **_бизнесовой_** точки зрения или если критично остановить эксперимент именно сейчас, то мощность может служить индикатором, что стоит продлить эксперимент и набрать еще наблюдений. Однако, это единичные случаи, которые относятся к важным продуктовым проектам.

## Итог

Процедура A/B-тестирования не показывает однозначно истинные эффекты от новых механик, а также не лишена тонкостей и подводных камней в организации и проведении. Вместе с тем, она остается единственным универсальным инструментом, устанавливающим причинно-следственные связи между внесенными изменениями и их влиянием на продукт.

Тем не менее, аккуратный подход к дизайну и понимание сложностей методологии предостерегут от соблазна свободной интерпретации результатов. В том числе, важно помнить, что статистическая значимость и практическая значимость — это разные вещи, и даже если различия статистически значимы, они не всегда имеют практическую ценность для бизнеса.

Итоговый вывод о положительном влиянии экспериментального воздействия делает аналитик на основе согласованности результатов статистического вывода сонаправленных метрик, от продуктовых прокси до бизнесовых денежных, и желательно поста-анализа эксперимента.