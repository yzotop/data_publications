---
tags:
  - data
link: https://habr.com/ru/companies/X5Tech/articles/763656/
source: habr
author: Nazarov
data_type:
  - AB tests
company: X5
---
Привет, Хабр! В этой статье мы затронем один из аспектов множественного тестирования, а именно определение оптимальных размеров групп в случае общей контрольной группы. Докажем теоретически, что предлагаемый способ является оптимальным и сравним его с другими популярными подходами.

Меня зовут [Саша](https://www.linkedin.com/in/amsakhnov), я работаю Head of DA/DS в X5 Tech. Мы с [Колей](https://www.linkedin.com/in/nazarovn) продолжаем писать серию статей по А/Б тестированию, это наша пятая статья. Первые четыре можно посмотреть тут:

1. [Стратификация. Как разбиение выборки повышает чувствительность А/Б теста](https://habr.com/ru/company/X5Tech/blog/596279/)    
2. [Бутстреп и А/Б тестирование](https://habr.com/ru/company/X5Tech/blog/679842/)    
3. [Проверка корректности А/Б тестов](https://habr.com/ru/company/X5Tech/blog/706388/    
4. [А/Б тесты с метрикой отношения. Дельта-метод](https://habr.com/ru/companies/X5Tech/articles/740476/)

Предположим, что мы проводим множество независимых А/Б тестов, тогда типичный способ разделения пользователей на группы выглядит следующим образом:

|   |   |
|---|---|
|A1|B1|
|A2|B2|
|A3|B3|
|A4|B4|

При этом после окончания экспериментов мы будем сравнивать ![A_i](https://habrastorage.org/getpro/habr/upload_files/14b/680/6f2/14b6806f23d26600704f66116f4d123a.svg) с ![B_i](https://habrastorage.org/getpro/habr/upload_files/cbd/c38/32d/cbdc3832ddb47c4b4ef891bb9ce04a8a.svg)соответственно. Пользователи контрольных групп не подвержены влияниям экспериментов, их поведение не должно отличаться друг от друга, поэтому их можно объединить в общую контрольную группу:

|   |   |   |   |   |
|---|---|---|---|---|
|A|B1|B2|B3|B4|

Таким образом, ставится вопрос об оптимальном разбиении трафика на группы при наличии одной контрольной группы и нескольких экспериментальных. Формализуем задачу:

Пусть у нас есть **N** пользователей, **1** контрольная группа, **k** экспериментальных групп. Положим, размер контрольной группы равен **n**, а размеры экспериментальных групп равны и равны **m.** Решается задача о нахождении оптимальных значений **n** и **m:**

|   |   |   |   |   |
|---|---|---|---|---|
|A|B1|...|...|Bk|

Соответствующие размеры групп:

|   |   |   |   |   |
|---|---|---|---|---|
|n|m|...|...|m|

Чтобы решить данную задачу, нам нужно определиться с терминами, а именно: что означает "оптимальное" разбиение? Так как мы говорим про А/Б тестирование, то наилучшим разбиением будем считать то, которое обеспечивает наименьшую дисперсию статистики. Одной из наиболее часто встречающихся статистик является t-статистика: 

![t = \frac{\overline{X} - \overline{Y} }{\sqrt{\frac{\hat{\sigma}_X^2}{n} + \frac{\hat{\sigma}_Y^2}{m}}}](https://habrastorage.org/getpro/habr/upload_files/89e/b4d/864/89eb4d8648d3f5f051ce0b1ef1d65417.svg)

Предполагается, что оценки дисперсий групп не являются случайными величинами и равны, что может быть адекватным предположением при больших размерах групп.

Поэтому задача сводится к нахождению такого разбиения, которое бы минимизировало следующий функционал:

![\frac{1}{n} + \frac{1}{m} \rightarrow \min\limits_{n, m}](https://habrastorage.org/getpro/habr/upload_files/3fd/0a6/113/3fd0a61130d4a461e9a7c336b884d7a5.svg)

Также есть условие регулярности, заключающееся в том, что распределяются все пользователи:

![N = n + k * m](https://habrastorage.org/getpro/habr/upload_files/56d/715/ad4/56d715ad415a5acb260d3e264a9496cb.svg)

Решим данную задачу оптимизации:

![](https://habrastorage.org/r/w1560/getpro/habr/upload_files/367/133/628/367133628a113b98f8ab83956e236ed8.png)

Таким образом, если в эксперименте одна экспериментальная группа ![(k=1)](https://habrastorage.org/getpro/habr/upload_files/f33/dc3/001/f33dc3001723cc14731581fd6837b709.svg), то получаем ожидаемый результат – разбить всех пользователей на две равные группы.

Если же экспериментальных групп ![k](https://habrastorage.org/getpro/habr/upload_files/0d9/8ec/3d4/0d98ec3d4698e4c8c7371f7237b40e7c.svg) больше, чем одна, то в каждую экспериментальную группу нужно выделить

![m=\frac{N}{k+\sqrt{k}}](https://habrastorage.org/getpro/habr/upload_files/d87/463/f8b/d87463f8b033610a012f7dcd5d0441f2.svg)

пользователей, а в контрольную

![n = \frac{N}{\sqrt{k}+1}](https://habrastorage.org/getpro/habr/upload_files/fee/c1b/5dc/feec1b5dceb2ca85b47c69f15d37ae19.svg)

пользователей. Ниже приведена таблица с размерами групп в процентном соотношении для разного количества экспериментов:

|   |   |   |
|---|---|---|
|k|n, %|m, %|
|1|50|50|
|2|41.4|29.3|
|3|36.6|21.1|
|4|33.3|16.7|
|5|30.9|13.8|
|10|24.0|7.6|
|20|18.3|4.1|
|50|12.4|1.8|
|100|9.1|0.9|

В заключении сравним данное разбиение с иными разбиениями, которые могут прийти в голову без аналитических выкладок.

1. Оптимальное разбиение:
    

|   |   |   |   |   |   |
|---|---|---|---|---|---|
|A|B1|B2|…|…|Bk|

![n = \frac{N}{\sqrt{k} + 1},~ m = \frac{N}{k+\sqrt{k}}](https://habrastorage.org/getpro/habr/upload_files/889/193/f1a/889193f1a95014ad5f1325190e1e61ca.svg)

2. Равномерное разбиение:
    

|   |   |   |   |   |   |
|---|---|---|---|---|---|
|A|B1|B2|…|…|Bk|

![n = m = \dfrac{N}{k+1}](https://habrastorage.org/getpro/habr/upload_files/eab/551/696/eab551696c9abe16e995ade5d24f6d8c.svg)

3. Контрольная группа занимает 50% выборки:
    

|   |   |   |   |   |   |
|---|---|---|---|---|---|
|A|B1|B2|…|…|Bk|

![n = \frac{N}{2}, ~m = \frac{N}{2k}](https://habrastorage.org/getpro/habr/upload_files/be7/90a/946/be790a946f4a0101ba897ba4b9ab87f1.svg)

В таблице представлены значения функционала ![N*\Big(\frac{1}{n} + \frac{1}{m}\Big)](https://habrastorage.org/getpro/habr/upload_files/f10/d39/9db/f10d399dbeba52a1652a354428b12a36.svg). Чем меньше, тем лучше. В последнем столбце произведён расчёт, во сколько раз меньший эффект возможно обнаружить при оптимальном разбиении относительно типичного разбиения:

|   |   |   |   |   |
|---|---|---|---|---|
|k|Оптимальное разбиение|Равномерное разбиение|50/50|MDE_uniform / MDE_optimal|
|1|4.0|4|4|1|
|2|5.8|6|6|1.01|
|3|7.5|8|8|1.04|
|4|9.0|10|10|1.05|
|5|10.5|12|12|1.07|
|10|17.3|22|22|1.13|
|20|29.9|42|42|1.18|
|50|65.1|102|102|1.25|
|100|121.0|202|202|1.29|

Так, если у вас **k=10** экспериментальных групп, то при оптимальном разбиении вы бы смогли обнаружить эффект в **1.13** раз меньший, чем при ином типичном разбиении.

Как это неудивительно, при равномерном разбиении и при разбиении 50 на 50 получаются одинаковые результаты.

![\frac{1}{n} + \frac{1}{m} \Bigg|_{n = \frac{1}{k+1}; m = \frac{1}{k+1}} = (k + 1) + (k + 1) = 2 +2k = \frac{1}{n} + \frac{1}{m} \Bigg|_{n = \frac{1}{2}; m = \frac{1}{2k}}](https://habrastorage.org/getpro/habr/upload_files/f83/316/7d6/f833167d62a01df4e98cadbf55deaa0c.svg)

Итого, когда в эксперименте присутствует всего одна экспериментальная группа, результаты согласуются и между собой, и со здравым смыслом. Происходит разделение на две равные части. При увеличении количества экспериментальных групп оптимальное разбиение помогает достичь большей чувствительности тестов по сравнению с другими способами разбиения.