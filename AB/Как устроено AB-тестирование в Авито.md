---
link: https://habr.com/ru/companies/avito/articles/454164/
tags:
  - data
source: habr
data_type:
  - AB tests
author: Lenkov
ab_type: AB_Platform
company: Avito
---
Всем привет. Меня зовут Данила, я работаю в команде, которая развивает аналитическую инфраструктуру в Авито. Центральное место в этой инфраструктуре занимает А/B-тестирование.
 

А/B эксперименты — ключевой инструмент принятия решений в Авито. В нашем цикле продуктовой разработки А/B-тест является обязательным этапом. Мы проверяем каждую гипотезу и выкатываем только позитивные изменения.


Мы собираем сотни метрик и умеем детализировать их до бизнес-разрезов: вертикали, регионы, авторизованные пользователи и т. д. Мы делаем это автоматизированно с помощью единой платформы для экспериментов. В статье я достаточно подробно расскажу, как платформа устроена и мы с вами погрузимся в некоторые интересные технические детали.

  

![](https://habrastorage.org/r/w1560/webt/ts/r_/qw/tsr_qwh3l7qfw2kob14z0lsaiya.png)

  

Основные функции платформы A/B мы формулируем следующим образом.

  

1. Помогает быстро запускать эксперименты
2. Контролирует нежелательные пересечения экспериментов
3. Считает метрики, стат. тесты, визуализирует результаты

  

Другими словами, платформа помогает наиболее быстро принимать безошибочные решения.

  

Если оставить за скобками процесс разработки фич, которые отправляются в тестирование, то полный цикл эксперимента выглядит так:

  

![](https://habrastorage.org/r/w1560/webt/ve/wd/by/vewdbye97eexzetbj3riubs-i1w.png)

  

- Заказчик (аналитик или продакт-менеджер) настраивает через админку параметры эксперимента.
- Сплит-сервис, согласно этим параметрам, раздает клиентскому устройству нужную группу A/B.
- Действия пользователей собираются в сырые логи, которые проходят через агрегацию и превращаются в метрики.
- Метрики «прогоняются» через статистические тесты.
- Результаты визуализируются на внутреннем портале на следующий день после запуска.

  

Весь транспорт данных в цикле занимает один день. Эксперименты длятся, как правило, неделю, но заказчик получает инкремент результатов каждый день.

  

Теперь давайте погрузимся в детали.

  

# Управление экспериментом

  

В админке для конфигурации экспериментов используется формат YAML.

  

[![](https://habrastorage.org/r/w1560/webt/lb/ko/k_/lbkok_pnexw8kzvdlkoq1jteuzy.png)](https://habrastorage.org/webt/lb/ko/k_/lbkok_pnexw8kzvdlkoq1jteuzy.png)

  

Это удобное решение для небольшой команды: доработка возможностей конфига обходится без фронта. Использование текстовых конфигов упрощает работу и пользователю: нужно делать меньше кликов мышкой. Похожее решение используется [A/B-фреймворке Airbnb](https://medium.com/airbnb-engineering/experiment-reporting-framework-4e3fcd29e6c0).

  

# Аллокация трафика

  

Для деления трафика на группы используем распространенную технику хеширования с солью.

  

![](https://habrastorage.org/r/w1560/webt/fs/ar/r_/fsarr_kezrgckfiuvf1w1uyuqfs.png)

  

Для устранения эффекта «памяти» пользователей, при запуске нового эксперимента, мы делаем дополнительное перемешивание второй солью:

  

![](https://habrastorage.org/r/w1560/webt/3-/qd/w0/3-qdw0xc2l0swwonorrgkfd_lpg.png)

  

Этот же принцип описан в [презентации Яндекса](https://habr.com/ru/company/yandex/blog/342704/).

  

Чтобы не допускать потенциально опасных пересечений экспериментов, мы используем логику, [схожую со «слоями» в Google](https://ai.google/research/pubs/pub36500). О наших слоях я рассказывал в [одном из докладов](https://youtu.be/OHL62aj93xY?t=436) на Матемаркетинге-2019.

  

Попробую дать вам интуитивное понимание слоев. Представим сначала, что мы не допускаем пересечений экспериментов вообще. Т. е. все эксперименты «разводятся» с помощью независимых диапазонов хешей. Так жить долго не получится — слишком маленькая пропускная способность.

  

Другая крайность — на каждый эксперимент выделять свою соль. Все эксперименты будут ортогональны друг другу. Опытный аналитик или разработчик знает — это тоже не всегда хорошо. Потому что эксперименты могут конфликтовать на уровне кода. Тестовые группы двух разных экспериментов могут быть с друг другом «несовместимы», что негативно скажется на опыте пользователей, а значит и на результатах обоих экспериментов.

  

Поэтому нужно решение по-середине. Разрешить безопасные ортогональные пересечения и запретить опасные. Другими словами, нужно ограничить создание солей и наделить каждую собственной семантикой (платформа, страница, регион пользователя и т. д.). Так и получаются слои. Задача платформы А/Б — обеспечить, чтобы потенциально конфликтующие эксперименты всегда находились в одном слое. А эксперименты, располагающиеся на разных слоях, не конфликтовали друг с другом на уровне кода или отображения пользователю.

  

# Сбор метрик

  

Сырые логи мы раскладываем в Vertica и агрегируем в таблицы-препараты со структурой:

  

![](https://habrastorage.org/r/w1560/webt/v6/tw/bv/v6twbvgj-togpdbylpqq21gfbz0.png)

  

Observations (наблюдения) — это, как правило, простые каунтеры событий. Наблюдения используются как компоненты в формуле расчета метрик.

  

Формула расчета любой метрики — это дробь, в числителе и знаменателе которой стоит сумма наблюдений:

  

![](https://habrastorage.org/r/w1560/webt/me/sb/or/mesbordzixv0yrcl4oo5nho5aa4.png)

  

В одном из [докладов Яндекса](https://youtu.be/vIdwgJFz5Mk?t=787) метрики подразделялись на два типа: по юзерам и Ratio. В этом есть бизнес-смысл, но в инфраструктуре удобнее все метрики считать единообразно в виде Ratio. Это обобщение валидно, потому что «поюзерная» метрика очевидно представима в виде дроби:

  

![](https://habrastorage.org/r/w1560/webt/d_/ih/l5/d_ihl5vdcvdguaohaytz5xkfepy.png)

  

Наблюдения в числителе и знаменателе метрики мы суммируем двумя способами.  
Простым:

  

![](https://habrastorage.org/r/w1560/webt/q9/fk/vc/q9fkvc6qsmj6dzwqknqnqwpgrts.png)

  

Это обычная сумма любого набора наблюдений: количество поисков, кликов по объявлениям и т. д.  
И посложнее:

  

![](https://habrastorage.org/r/w1560/webt/iu/_s/ru/iu_srukdm2pyxrvoizc68butlx8.png)

  

Уникальное количество ключей, в группировке по которым сумма наблюдений больше заданного порога.

  

Такие формулы легко задаются с помощью YAML-конфига:

  

![](https://habrastorage.org/r/w1560/webt/ga/i3/qj/gai3qjape-xmwg2pyfg0snj6lao.png)

  

Параметры groupby и threshold опциональны. Как раз они и определяют второй способ суммирования.

  

Описанные стандарты позволяют сконфигурировать почти любую онлайн-метрику, которую только можно придумать. При этом сохраняется простая логика, не накладывающая избыточную нагрузку на инфраструктуру.

  

# Статистический критерий

  

Значимость отклонений по метрикам мы измеряем классическими методами: [T-test](https://en.wikipedia.org/wiki/Welch%27s_t-test), [Mann-Whitney U-test](https://en.wikipedia.org/wiki/Mann%E2%80%93Whitney_U_test). Главное необходимое условие для применения этих критериев — наблюдения в выборке не должны зависеть друг от друга. Почти во всех наших экспериментах мы считаем, что пользователи (Uid) удовлетворяют этому условию.

  

![](https://habrastorage.org/r/w1560/webt/v-/ya/nz/v-yanzyx8c--fqqgnzkhlkg4j0c.png)

  

Теперь возникает вопрос: как провести T-test и MW-test для Ratio-метрик? Для T-test нужно уметь считать дисперсию выборки, а для MW выборка должна быть «поюзерной».

  

![](https://habrastorage.org/r/w1560/webt/d-/7j/p2/d-7jp2xfsktkjajzki-wrp8sugw.png)

  

Ответ: нужно разложить [Ratio в ряд Тейлора до первого порядка в точке ![$({E}\left[X\right], {E}\left[Y\right])$](https://habrastorage.org/getpro/habr/formulas/52a/019/7a7/52a0197a735d62cb00eba1b49da8fdd2.svg)](http://www.stat.cmu.edu/~hseltman/files/ratio.pdf) :

  

![](https://habrastorage.org/r/w1560/webt/ky/im/td/kyimtdhnynvygcu_r867uzeoubu.png)

  

Данная формула преобразует две выборки (числитель и знаменатель) в одну, сохраняя среднее и дисперсию (асимптотически), что позволяет применять классические стат. тесты.

  

![](https://habrastorage.org/r/w1560/webt/il/h3/ac/ilh3acbdbdjnszyjezba85ee4ku.png)

  

Похожую идею коллеги из Яндекса называют методом линеаризации Ratio (выступления [раз](https://youtu.be/vIdwgJFz5Mk?t=1062) и [два](https://youtu.be/PE29k3CP72U?t=1209)).

  

UPD. Для расчета дисперсии Ratio и применения t-теста можно сразу воспользоваться [Дельта-методом](https://arxiv.org/pdf/1803.06336.pdf). При большом объеме данных это куда более простое решение, т. к. необходимо лишь сделать три простые агрегации: сумма числителя и знаменателя отдельно, сумма их квадратов, и сумма их попарных произведений.

  

# Производительность при масштабировании

  

Использование быстрых для CPU стат. критериев дает возможность проводить миллионы итераций (сравнений treatment vs. control) за считанные минуты на вполне обычном сервере с 56 ядрами. Но в случае больших объемов данных производительность упирается, в первую очередь, в хранение и время считывания с диска.

  

Расчет метрик по Uid ежедневно порождает выборки общим размером в сотни миллиардов значений (ввиду большого количества одновременных экспериментов, сотен метрик и кумулятивного накопления). Каждый день выгребать такие объемы с диска слишком проблематично (несмотря на большой кластер колоночной базы Vertica). Поэтому мы вынужденно сокращаем кардинальность данных. Но делаем это почти без потери информации о дисперсии с помощью техники, которую называем «Бакеты».

  

Идея проста: хешируем Uid'ы и по остатку от деления «разбрасываем» их на некоторое количество бакетов (обозначим их число за B):

  

![](https://habrastorage.org/r/w1560/webt/cd/1h/x-/cd1hx-k8rgilkmwxafotz3-tgok.png)

  

Теперь переходим к новой экспериментальной единице — бакет. Наблюдения в бакете суммируем (числитель и знаменатель независимо):

  

![](https://habrastorage.org/r/w1560/webt/yv/jq/bz/yvjqbz34yd8yswtoff50zpgj3g0.png)

  

При таком преобразовании условие о независимости наблюдений выполняется, значение метрики не изменяется, и легко проверить, что и дисперсия метрики (среднего по выборке наблюдений) сохраняется:

  

![](https://habrastorage.org/r/w1560/webt/df/ku/6p/dfku6pb74plagc0doxg62blhdly.png)

  

Чем больше бакетов, тем меньше информации теряется, и тем меньше ошибка в равенстве. В Авито мы берем B = 200.

  

Плотность распределения метрики после бакетного преобразования всегда становится схожа с нормальным.

  

![](https://habrastorage.org/r/w1560/webt/fk/sa/rf/fksarfomowkwdzzhwveb10vbtr0.png)

  

Сколь угодно большие выборки можно сокращать до фиксированного размера. Рост в количестве хранимых данных в таком случае лишь линейно зависит от количества экспериментов и метрик.

  

# Визуализация результатов

  

В качестве инструмента визуализации мы используем Tableau и веб-вью на Tableau Server. У каждого сотрудника Авито есть туда доступ. Следует отметить, что Tableau с задачей справляется хорошо. Реализовать аналогичное решение с помощью полноценной бэк/фронт разработки было бы куда более ресурсоемкой задачей.

  

UPD. С ростом данных Табло-сервер становится либо слишком медленным, либо слишком дорогим. Рекомендую сразу вложиться в визуализацию на вебе собственными руками.

  

Результаты каждого эксперимента — это простыня из нескольких тысяч чисел. Визуализация обязана быть такой, чтобы минимизировать неправильные выводы в случае реализации [ошибок I и II рода](https://en.wikipedia.org/wiki/Type_I_and_type_II_errors), и при этом не «проморгать» изменения в важных метриках и срезах.

  

Во-первых, мы мониторим метрики «здоровья» экспериментов. Т. е. отвечаем на вопросы: «Поровну ли участников "налилось" в каждую из групп?», «Поровну ли авторизованных или новых пользователей?».

  

[![](https://habrastorage.org/r/w1560/webt/k1/-r/-x/k1-r-xrjn1gyeg8-o6-9eolq-qe.png)](https://habrastorage.org/webt/k1/-r/-x/k1-r-xrjn1gyeg8-o6-9eolq-qe.png)

  

В случае статистически значимых отклонений соответствующие клеточки подсвечиваются. При наведении на любое число отображается кумулятивная динамика по дням.

  

[![](https://habrastorage.org/r/w1560/webt/ju/ke/z0/jukez0yfvsmoyu_gmpy384rsmzc.png)](https://habrastorage.org/webt/ju/ke/z0/jukez0yfvsmoyu_gmpy384rsmzc.png)

  

Главный дашборд с метриками выглядит так:

  

[![](https://habrastorage.org/r/w1560/webt/ng/mb/ju/ngmbjufio9wsbf0mnpld0ldqajq.png)](https://habrastorage.org/webt/ng/mb/ju/ngmbjufio9wsbf0mnpld0ldqajq.png)

  

Каждая строка — сравнение групп по конкретной метрике в конкретном разрезе. Справа — панель с фильтрами по экспериментам и метрикам. Снизу — панель фильтров по разрезам.

  

Каждое сравнение по метрике состоит из нескольких показателей. Разберем их значения слева направо:

  

**1. MDE. Minimum Detectable Effect**

  

[![](https://habrastorage.org/r/w1560/webt/sy/xw/gk/syxwgkaimg-pgsqtnrriv8ybf5e.png)](https://habrastorage.org/webt/sy/xw/gk/syxwgkaimg-pgsqtnrriv8ybf5e.png)

  

⍺ и β — заранее выбранные вероятности ошибки I и II рода. MDE очень важен, если изменение статистически не значимо. При принятии решения заказчик должен помнить, что отсутствие стат. значимости не равносильно отсутствию эффекта. Достаточно уверенно можно утверждать лишь то, что возможный эффект не больше, чем MDE.

  

**2. MW | T. Результаты Mann-Whitney U- и T-test**

  

[![](https://habrastorage.org/r/w1560/webt/za/vs/j8/zavsj8pnzmrazz-maz_lucwjrti.png)](https://habrastorage.org/webt/za/vs/j8/zavsj8pnzmrazz-maz_lucwjrti.png)

  

На панель выводим значение z- и t-статистики (для MW и T соответственно). В тултип — динамику p-value. Если изменение значимое, то клетка подсвечивается красным или зеленым цветом в зависимости от знака разницы между группами. В таком случае мы говорим, что метрика «прокрасилась».

  

**3. Lift. Разница между группами в процентах**

  

[![](https://habrastorage.org/r/w1560/webt/cr/db/fk/crdbfkcytwrjdzez3l-v1gu1c8e.png)](https://habrastorage.org/webt/cr/db/fk/crdbfkcytwrjdzez3l-v1gu1c8e.png)

  

**4. Mean | Num | Den. Значение метрики, а также числитель и знаменатель отдельно**

  

[![](https://habrastorage.org/r/w1560/webt/8d/kc/wp/8dkcwpugkmf6f6qqdrmnksp-rda.png)](https://habrastorage.org/webt/8d/kc/wp/8dkcwpugkmf6f6qqdrmnksp-rda.png)

  

К числителю и знаменателю применяем еще один T-test, который помогает понять, чей вклад решающий.

  

**5. Std. Выборочное стандартное отклонение**  
**6. Hist. Тест Шапиро-Уилка на нормальность «бакетного» распределения.**

  

[![](https://habrastorage.org/r/w1560/webt/0d/dh/h6/0ddhh68_mdhgjpb6dyufnucnmfc.png)](https://habrastorage.org/webt/0d/dh/h6/0ddhh68_mdhgjpb6dyufnucnmfc.png)

  

Если индикатор красный, то, возможно, в выборке есть выбросы или аномально длинный хвост. В таком случае принимать результат по этой метрике нужно осторожно, либо не принимать вовсе. Клик на индикатор открывает гистограммы метрики по группам. По гистограмме однозначно видны аномалии — так проще делать выводы.

  

# Заключение

  

Появление платформы A/B в Авито — переломная точка, когда наш продукт стал развиваться быстрее. Каждый день мы принимаем «зеленые» эксперименты, которые заряжают команду; и «красные», которые дают полезную пищу для размышлений.

  

Нам удалось построить эффективную систему A/B-тестинга и метрик. Часто сложные проблемы мы решали простыми методами. Благодаря этой простоте, инфраструктура имеет хороший запас прочности.

  

Уверен, те, кто собирается построить платформу A/B в своей компании, нашли в статье несколько интересных инсайтов. Я рад поделиться с вами нашим опытом.

  

Пишите вопросы и комментарии — постараемся на них ответить.