---
tags:
  - data
link: https://habr.com/ru/companies/kuper/articles/827448/
source: habr
data_type:
  - AB tests
author: Kuper
company: Kuper
---
Привет, Хабр! Меня зовут Евгений Узянов, я продуктовый аналитик в команде геймификации Купера (ex СберМаркет). Каждый месяц мы проводим десятки экспериментов на миллионах клиентов, чтобы улучшить опыт пользователей и экономику сервиса. Мы выдвигаем много гипотез, одновременно проводим большое количество тестов с разнообразной спецификой —  поэтому нам важно глубоко понимать процесс проверки гипотез и уметь разобрать эксперимент до атомов.

В этой статье поговорим про статистические критерии:

- узнаем, что это такое
- разберем, в чем их «физический смысл» 
- посмотрим, для чего они используются, и что с ними делать
- изучим часто встречающиеся на практике кейсы

Эта статья будет полезна для тех, кто начинает изучать AB-тестирование или хочет структурировать имеющиеся знания.

![](https://habrastorage.org/r/w1560/getpro/habr/upload_files/e9e/768/a38/e9e768a38f7f54ba9ca868fb0065e23e.png)

Когда я только начинал изучать методы количественного тестирования, я искал информацию в большом количестве источников: университетские лекции, онлайн-курсы, литература разной степени глубины и, конечно же, ютуб. В значительном количестве случаев при знакомстве с очередной статистикой информация преподносилась в следующем формате:

1. Держи страшную формулу
2. Вот какие-то графики с хвостами
3. Ну а дальше все понятно
4. Иди работай

Вместо такого подхода мы разберем по винтикам несколько статистических критериев и попытаемся понять, что лежит за математическими формулами. В процессе вы увидите, что за громоздкими и страшными математическими конструкциями лежат простые и понятные идеи.

![](https://habrastorage.org/r/w1560/getpro/habr/upload_files/115/a3e/9d4/115a3e9d43534c8ca43d312daafecf59.png)

## Терминология

Сначала зафиксируем несколько важных понятий и разберем их на простых примерах.

> **Функция плотности распределения случайной величины в точке Х**: для простоты будем считать, что это _вероятность принятия_ случайной величиной _значения Х_.

Если же не привязываться к конкретной точке, то плотность распределения — это математическое правило, описывающее для каждого допустимого значения случайной величины вероятность того, что именно это значение будет принято.

Пример c кубиком

![F(x) = \begin{cases} 0, & \text{если х < 1} \\ 1/6, & \text{если х } \subset \text{ [1, 6], } x \in \mathbb{Z}\\ 0, & \text{если х > 6} \end{cases}](https://habrastorage.org/getpro/habr/upload_files/095/628/e1a/095628e1a3f17d23f7df2677dae1aab8.svg)

Пример со школьниками

![Нормальное распределение миллиона школьников по росту](https://habrastorage.org/r/w1560/getpro/habr/upload_files/30a/ec1/5b0/30aec15b0b894ceedd6f75985040e0a3.png "Нормальное распределение миллиона школьников по росту")

![f(x) = \frac{1}{\sigma\sqrt{2\pi}} e^{-\frac{1}{2}\left(\frac{x-\mu}{\sigma}\right)^2}](https://habrastorage.org/getpro/habr/upload_files/9ae/e5a/946/9aee5a9461a58d6d62c89570626934cc.svg)

![a = \frac{1}{\sigma\sqrt{2\pi}} \\](https://habrastorage.org/getpro/habr/upload_files/c13/6c8/25a/c136c825ab114a4db5d7f8c25a988d50.svg)

![b(x) = \left(\frac{x-\mu}{\sigma}\right)^2](https://habrastorage.org/getpro/habr/upload_files/dac/322/3cf/dac3223cf61977d59d18616f35684a3d.svg)

> **Функция распределения случайной величины:** математическое правило, описывающее вероятность _попадания случайной величины в_ _интервал значений_. Это определение связано с функцией плотности следующим образом: функция распределения — это интеграл от функции плотности ( то есть суммой плотности вероятности в каждой точке рассматриваемого интервала).

Пример с кубиком

![\text{F(x) = F(x} \leq \text{p) =}  \begin{cases}  0, & \text{если х < 1} \\  \frac{p}{6}, & \text{если х } \subset \text{ [1, 6], } x \in \mathbb{Z}\\  0, & \text{если х > 6}  \end{cases} \\ \text{p - произвольное целое число от 1 до 6}](https://habrastorage.org/getpro/habr/upload_files/d2d/2d1/af6/d2d2d1af63ba910639361a12df315e1c.svg)

![F(x) = F(x \leq 3) = \frac{3}{6} = 50\%](https://habrastorage.org/getpro/habr/upload_files/bb6/b64/cd2/bb6b64cd2c983cc12cb61a69672cd2b9.svg)

Пример со школьниками

![F(x) = \frac{1}{\sigma\sqrt{2\pi}} \int_{-\infty}^{x} e^{-\frac{1}{2}\left(\frac{t-\mu}{\sigma}\right)^2} dt](https://habrastorage.org/getpro/habr/upload_files/2a2/7da/df8/2a27dadf8d888bf76547e98efe63b329.svg)

![\text{x = 145, рост, ниже которого производится оценка} \\ \mu \text{= 165, средний рост по множеству} \\ \sigma \text{= 10, стандартное отклонение множества}](https://habrastorage.org/getpro/habr/upload_files/768/b4a/e29/768b4ae292954bd168c79dc268f41aca.svg)

> **Статистическая гипотеза**: если мы возьмем какую-нибудь случайную величину и выдвинем некоторое утверждение насчет его распределения, то оно и будет статистической гипотезой.

Пример с кубиком

Пример со школьниками

> **Статистический критерий (он же статистика и статистический тест):** математическое правило, в соответствии с которым принимается или отвергается та или иная статистическая гипотеза с заданным уровнем значимости.

Для этого определения мы рассмотрим более подробные примеры ниже:

## Критерий Стьюдента

Допустим, вы аналитик, к которому пришел менеджер продукта с новой фичей. Согласно гипотезе продакта, такое изменение гипотетически должно увеличить суммарную выручку с каждого клиента (ARPU).

Теперь представим, что после построения дизайна и проведения эксперимента, проверяющего гипотезу, у вас есть набор данных о выручке с каждого клиента из тестовой и контрольной групп. Но как сравнить эти данные?

Самое очевидное решение: сравнить средние значения суммарной выручки в каждой из групп. Но как в таком случае понять, насколько мала или велика полученная разница? Допустим, отличие составляет 17,5 рублей, как в таблице ниже — как интерпретировать такое значение?

|   |   |   |   |
|---|---|---|---|
|Метрика|Контрольная группа|Тестовая группа|Абсолютная разница|
|ARPU|3048.1 рублей|3065.6 рублей|17.5 рублей|

Насколько полученная разность выборочных средних значительна, будем оценивать исходя из _стандартного отклонения разности выборочных средних_ — оно представляет собой меру разброса возможных значений разности средних выручек с клиента между тестовой и контрольной группой. Полученную оценку «значительности» назовем переменной t.

![t = \frac{\bar x_{test} - \bar x_{control}}{\sigma_{\bar x_{test} - \bar x_{control}}}\\ \\ \bar x_{test} - \text{среднее ARPU в тестовой группе}\\ \bar x_{control} - \text{среднее ARPU в контрольной группе}\\ \sigma_{\bar x_{test} - \bar x_{control}} - \text{стандартное отклонение разности выборочных средних}](https://habrastorage.org/getpro/habr/upload_files/6ce/8a4/3f3/6ce8a43f32c5694f5173724d885e11b0.svg)Еще раз и помедленнее

В реальности бывает затруднительно определить истинное стандартное отклонение разности выборочных средних. Вместо него в знаменателе будем использовать [оценку данного параметра](https://habr.com/ru/companies/lanit/articles/799317/) — ее называют _стандартной ошибкой разности выборочных средних_. После математических преобразований получим формулу:

![t = \frac{\bar x_{test} - \bar x_{control}}{\sqrt{\frac{s_{test}^2}{n_{test}} + \frac{s_{control}^2}{n_{control}}}}\\ s_{test} - \text{стандартное отклонение в тестовой выборке}\\ s_{control} - \text{стандартное отклонение в контрольной выборке}\\ n_{test} - \text{кол-во элементов в тестовой выборке}\\ n_{control} - \text{кол-во элементов в контрольной выборке}](https://habrastorage.org/getpro/habr/upload_files/56f/1bb/7fc/56f1bb7fc0b4f78fc60d41a058114a92.svg)

Поздравляем, мы только что изобрели критерий Стьюдента! Он используется в ситуациях, когда:

- рассматриваются случайные нормально распределенные независимые величины,
- стандартное отклонение генеральных совокупностей неизвестны,
- сравниваемые выборки независимы, имеют одинаковое стандартное отклонение, а в каждой из них не менее 30 наблюдений.


В моем опыте это наиболее часто используемый критерий, который после [некоторых преобразований](https://habr.com/ru/companies/sbermarket/articles/768826/) данных применим в огромном количестве случаев.

## Критерий Манна-Уитни

Допустим, мы столкнулись со следующей ситуацией: служба поддержки использовала новый скрипт для общения с клиентами. После этого собирали обратную связь от пользователей о качестве сервиса — от 1 до 10 баллов. Результаты получились следующими:

| **Старый скрипт**   |            | **Новый скрипт**    |            |
| ------------------- | ---------- | ------------------- | ---------- |
| **id пользователя** | **Оценка** | **id пользователя** | **Оценка** |
| cc61bb00            | 3          | e2192d0f            | 1          |
| cffcc1c0-7          | 4          | 52aac80b            | 2          |
| d5e2722a            | 5          | fdfdebaa            | 2          |
| 973bf010            | 5          | aec0dd98            | 3          |
| 488ebe02            | 6          | 75133ce6            | 3          |
| 15f659e0            | 7          | 6d0b7521            | 4          |
| 35ad5100            | 8          | e1726c46            | 9          |
| 0f215aef            | 8          | 9d3916d2            | 9          |
| 9ef620b7            | 8          | 58c72449            | 9          |
| 1661987e            | 8          | 7af79d13            | 9          |
|                     |            | 201a9ce0            | 9          |
|                     |            | 37adf0a8            | 10         |

Как в такой ситуации выявить лучший скрипт?

Заметно, что данные не распределены нормально, а количество наблюдений слишком мало для применения критерия Стьюдента. В таком случае применимы непараметрические критерии. В качестве примера рассмотрим критерий Манна — Уитни. Он используется, когда:

- есть две независимые выборки (большее количество рассматривается [критерием Краскера — Уоллиса](https://ru.wikipedia.org/wiki/%D0%9A%D1%80%D0%B8%D1%82%D0%B5%D1%80%D0%B8%D0%B9_%D0%9A%D1%80%D0%B0%D1%81%D0%BA%D0%B5%D0%BB%D0%B0_%E2%80%94_%D0%A3%D0%BE%D0%BB%D0%BB%D0%B8%D1%81%D0%B0)),
    
- выборки ранжированы, а элементы упорядочены относительно друг друга,
    
- в каждой выборке не меньше трех наблюдений.
    

Расчет состоит из нескольких шагов.

1. Пронумеруем все значения в порядке возрастания.
    
|                     |            |                     |            |
| ------------------- | ---------- | ------------------- | ---------- |
| **Старый скрипт**   |            | **Новый скрипт**    |            |
| **id пользователя** | **Оценка** | **id пользователя** | **Оценка** |
| cc61bb00            | 3          | e2192d0f            | 1          |
| cffcc1c0-7          | 4          | 52aac80b            | 2          |
| d5e2722a            | 5          | fdfdebaa            | 2          |
| 973bf010            | 5          | aec0dd98            | 3          |
| 488ebe02            | 6          | 75133ce6            | 3          |
| 15f659e0            | 7          | 6d0b7521            | 4          |
| 35ad5100            | 8          | e1726c46            | 9          |
| 0f215aef            | 8          | 9d3916d2            | 9          |
| 9ef620b7            | 8          | 58c72449            | 9          |
| 1661987e            | 8          | 7af79d13            | 9          |
|                     |            | 201a9ce0            | 9          |
|                     |            | 37adf0a8            | 10         |

    
Когда встречаются несколько одинаковых значений, они нумеруются произвольно. Затем с каждым сопоставляется среднее значение среди таких рангов. Например, оценки, равные 3, имеют ранги 4 (клиент cc61bb00), 5 (клиент 52aac80b) и 6 (клиент fdfdebaa). Взяв среднее арифметическое по рангам одинаковых оценок, всем «тройкам» сопоставляется ранг «5».  
    
4. Для каждой группы произведем расчет суммы рангов.
    
    ![R_{1} = \sum_{i} {rank_{i_{1}}} \\ R_{2} = \sum_{i} {rank_{i_{2}}} \\ R_{1} - \text{сумма рангов группы со старым скриптом} \\ {rank_{i_{1}}} - \text{ранги оценок из группы со старым скриптом} \\ R_{2} - \text{сумма рангов группы с новым скриптом} \\ {rank_{i_{2}}} - \text{ранги оценок из группы с новым  скриптом}](https://habrastorage.org/getpro/habr/upload_files/7ed/175/963/7ed175963159b9810395dcd581814c0e.svg)
5. Основываясь на предположении, что гипотеза о равенстве медиан верна и элементы обеих выборок равномерно распределены между собой, для обеих групп посчитаем ожидаемую сумму рангов. Формулы ниже по сути представляют собой сумму арифметической прогрессии.
    
    ![E(R_1) = \frac{n_1(n+1)}{2} \\ E(R_2) = \frac{n_2(n+1)}{2} \\ n = n_1 + n_2 \\ n_1 = 10 - \text{кол-во элементов в группе со старым скриптом} \\ n_2 = 12 - \text{кол-во элементов в группе с новым скриптом} \\](https://habrastorage.org/getpro/habr/upload_files/a1c/163/9bc/a1c1639bcef7c108300667fb1e8d7bc6.svg)
6. Добавим к ожидаемым рангам дополнительный коэффициент, равный общему числу пар элементов, которые можно образовать из элементов первой и второй выборок. При неравных размерах выборок (как в нашем случае) он помогает учитывает вклад большей выборки в общую сумму рангов и позволяет нам корректно оценить ожидаемую сумму рангов элементов меньшей выборки.
    
    ![E(R_1)_{norm} = n_1 * n_2 + E(R_1) \\ E(R_2)_{norm} = n_1 * n_2 + E(R_2) \\](https://habrastorage.org/getpro/habr/upload_files/07c/bd4/326/07cbd4326a00375fde4dae01def52d5e.svg)
7. И, наконец, посчитаем критерий Манна-Уитни в переменной U.
    
    ![U_1 = E(R_1)_{norm} - R_1 \\ U_2 = E(R_2)_{norm} - R_2 \\ U = min(U_1, U_2)](https://habrastorage.org/getpro/habr/upload_files/af9/b3e/60c/af9b3e60cc5cb637b0e34cfaae900b01.svg)

Как видим, суть параметра U и рассматриваемого статтеста заключается в поиске минимального размера отклонения фактической суммы рангов от ожидаемой (т. е. Той, которая существовала бы при равномерном распределении рангов в группах).

## Критерий Пирсона

Теперь рассмотрим пример с анализом категориальных данных — таких, у которых все возможные значения составляют фиксированный набор категорий, а не чисел, измеряющих величину на непрерывной шкале. Например, человек может описывать свой пол как мужской или женский, а деталь может быть синей или зеленой.

Допустим, коллеги из маркетинга принесли вам данные ниже и попросили оперативно выяснить, есть ли связь между выдачей промокода на первый заказ в сервисе и оформлением второго заказа — то есть тем, возвращается ли клиент.

|   |   |   |
|---|---|---|
||Сделали первый заказ с промокодом|Сделали первый заказ без промокода|
|Не вернулись в повторный заказ|60|300|
|Вернулись в повторный заказ|10|390|

Для этого упрощенного случая хорошо применим критерий Пирсона (еще его называют критерием независимости хи-квадрат). Говоря простыми словами, эта статистика основывается на сравнении разницы между ожидаемыми и фактическими значениями в каждой ячейке таблицы. Наблюдаемые значения — те, которые мы просто получили на практике. Ожидаемые — те, которые мы ожидали бы увидеть, если бы переменные «факт выдачи промокода на первый заказ» и «факт возвращения в повторный заказ» были действительно независимыми.

Формула для критерия Пирсона выглядит так:

![X^2 = \sum_{i, j} \frac{{(E_{ij} - O_{ij})}^2}{E_{ij}} \\ E_{ij} - \text{ожидаемое значение i-ой строке j-ом столбце}\\ O_{ij} - \text{наблюдаемое значение i-ой строке j-ом столбце}](https://habrastorage.org/getpro/habr/upload_files/a94/5b3/d75/a945b3d753a489d50082639a54898667.svg)

Как видим, мы всего лишь считаем и суммируем отклонение наблюдаемого значения в ячейке относительно ожидаемого значения в единицах ожидаемого значения, суммируя результаты такой операции по всей таблице.

Подробнее про расчеты

![E_{ij} = \frac{\text{(суммма i-ой строки)} * \text{(сумма j-го столбца)}}{\text{общая сумма всех ячеек}}](https://habrastorage.org/getpro/habr/upload_files/9bd/f82/ddc/9bdf82ddca851bdda498d857b76d8d11.svg)

![E_{11} = \frac{\text{360} * \text{70}}{\text{760}} = 33.16](https://habrastorage.org/getpro/habr/upload_files/8ac/952/1c3/8ac9521c32af9271e3168bffa75e1a28.svg)

|   |   |   |
|---|---|---|
||||
||||
||||

![X^2 = 45.474](https://habrastorage.org/getpro/habr/upload_files/9c4/792/768/9c47927689e782e3730ccdc891319710.svg)

Критерий Пирсона применяется в ситуациях, когда:

- есть две выборки с независимыми наблюдениями,
    
- в каждой из выборок не менее 30 наблюдений,
    
- данные дискретны.
    

## Что делать с полученным критерием?

Допустим, мы начали понимать, что лежит в механизмах некоторых критериев, а также научились считать их для ряда случаев. Конечно же, возникает вопрос: что дает посчитанное значение критерия? И как с его помощью оценивать уровень значимости принятия / отвержения гипотезы?

Для поиска ответа вернемся к примеру с критерием Стьюдента: предположим, t-значение равно нулю. Это означает, что средние выборочные значения метрик в тестовой и контрольной группах совпадают. В таком случае почти наверняка можно сказать, что отличий между группами нет. Увеличение значения критерия Стьюдента будет означать, что разность выборочных средних значений исследуемой метрики между тестом и контролем становится все больше по сравнению со стандартным отклонением разности выборочных средних. И поэтому чем больше значение t-критерия, тем меньше вероятность, что разность между группами случайна.

Таким образом, на качественном уровне значение критерия — это прокси-метрика значимости отличий между группами!

Чтобы проводить количественное соответствие между полученным значением статистики и значимостью отличий, используются специальные таблицы для соответствующего статистического критерия. В случае автоматизированного подхода используются функции специализированных библиотек, которые подбирают p-value под ваши выборки, степени свободы и посчитанное значение критерия.

## Теперь я все знаю?

Для аналитика понимание принципов работы статистических критериев — один из самых базовых навыков, необходимых для выстраивания и поддержки культуры АБ-тестирования. Полезно понимать область применимости и «физический смысл», который лежит за математическими формулами — чтобы в любой ситуации знать, что предложить для грамотного количественного тестирования решений для бизнеса.

Если вам интересно влиять на бизнес с помощью данных, приходите к нам в команду — [всегда найдутся направления по вкусу](https://team.sbermarket.ru/tech).