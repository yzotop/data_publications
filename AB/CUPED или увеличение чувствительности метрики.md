---
tags:
  - data
author: expf
source: medium
link: https://medium.com/statistics-experiments/cuped-%D0%B8%D0%BB%D0%B8-%D1%83%D0%B2%D0%B5%D0%BB%D0%B8%D1%87%D0%B5%D0%BD%D0%B8%D0%B5-%D1%87%D1%83%D0%B2%D1%81%D1%82%D0%B2%D0%B8%D1%82%D0%B5%D0%BB%D1%8C%D0%BD%D0%BE%D1%81%D1%82%D0%B8-%D0%BC%D0%B5%D1%82%D1%80%D0%B8%D0%BA%D0%B8-de7183fc964c
data_type:
  - AB tests
company: expf
---
С темпами развития культуры экспериментов в компаниях вопрос о методах анализа результатов перестает быть самым актуальным.

На передний план выходят такие проблемы, как увеличение чувствительности метрик и ускорение сходимости дисперсии.


Вариантов для увеличения чувствительности достаточно много — стратификация, классификаторы, трансформация метрик и т.п. Но сегодня мы поговорим про один из самых легко интерпретируемых и эффективных методов, а именно **CUPED.**

Сам метод популяризирован командой [exp-platform](https://exp-platform.com/) из Microsoft и активно используется ими, а еще booking, google, netflix, airbnb и другими.

**Что такое CUPED**

==Суть CUPED заключается в том, что мы учитываем поведение пользователя до эксперимента(ковариата) и после эксперимента (фактическая метрика) и пытаемся найти между этими метриками зависимости.==

![](https://miro.medium.com/v2/resize:fit:700/1*rHPpiIPd8-7EVhvGcPg8nQ.png)

**Как это работает**

Метрика CUPED считается следующим образом:

![](https://miro.medium.com/v2/resize:fit:700/1*5SQ38_GAUtgr8N3P1_tMcw.png)

- **covariate** — _метрика до эксперимента_
- **metric** — _метрика после эксперимента_
- **theta** вычисляется как

![](https://miro.medium.com/v2/resize:fit:590/1*dZsYVoCRZe7JdvJjKGOF8Q.png)

Именно за счет этого куска формулы и меняется дисперсия. Если ковариация большая, то дисперсия сократится значительно.

Важно отметить, что CUPED хорошо поддается развитию. Можно использовать ошибки от предикта в моделях, в которых используется несколько ковариат — при таких подходах можно значительно увеличивать эффект полученный от метода.

Сам поиск covariate может стать исследовательским процессом, причем достаточно увлекательным.

Но для базового использования можно взять просто метрику пользователя до самого эксперимента.

Допустим, чек у пользователя до эксперимента был 2.500 , а после эксперимента стал 2.650 — на основе этих метрик мы и будем строить модель.

В результате преобразования получаем поюзерную метрику CUPED.

![](https://miro.medium.com/v2/resize:fit:700/1*jy2u6DGV_kkKCqPHuq-mLw.png)

Теперь можно оценить ее описательные статистики , распределение и сравнить дисперсию итоговой метрики и CUPED.

![](https://miro.medium.com/v2/resize:fit:700/1*NSNm_usTL1wkkSqUnifI2g.png)

![](https://miro.medium.com/v2/resize:fit:700/1*lXvNmWnxM4renSSO3QhyKw.png)

По графикам и описательным статистикам видно, что CUPED значительно сокращает дисперсию и меняет форму исходного распределения метрики. При этом важные статистики остаются интерпретированы.

**Как это сказывается на результатах экспериментов**

![](https://miro.medium.com/v2/resize:fit:700/1*lNEq__X9_uoOJdh7galchw.png)

Для оценки влияния на скорость эксперимента мы можем оценить как меняется сходимость дисперсии в “до CUPED” и “CUPED”.

![](https://miro.medium.com/v2/resize:fit:700/1*abw8npd318YzNgtOyarAvQ.png)

По графику видно, что дисперсия начинает сходиться к 1 на меньшем количестве наблюдений. Следовательно, мы могли бы раньше принять решение о результатах.

Для итоговой оценки a/b теста после применения CUPED можно использовать [bootstrap](https://medium.com/statistics-experiments/%D0%BD%D0%B5%D0%BF%D0%B0%D1%80%D0%B0%D0%BC%D0%B5%D1%82%D1%80%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%B8%D0%B5-%D0%BC%D0%B5%D1%82%D0%BE%D0%B4%D1%8B-%D0%B4%D0%BB%D1%8F-a-b-%D1%82%D0%B5%D1%81%D1%82%D0%BE%D0%B2-%D1%81%D1%87%D0%B8%D1%82%D0%B0%D0%B5%D0%BC-%D0%B4%D0%B5%D0%BD%D1%8C%D0%B3%D0%B8-4b854df151cd) или [параметрический t.test](https://medium.com/statistics-experiments/%D0%BD%D0%B5%D0%BF%D0%B0%D1%80%D0%B0%D0%BC%D0%B5%D1%82%D1%80%D0%B8%D1%87%D0%B5%D1%81%D0%BA%D0%B8%D0%B5-%D0%BC%D0%B5%D1%82%D0%BE%D0%B4%D1%8B-%D0%B4%D0%BB%D1%8F-a-b-%D1%82%D0%B5%D1%81%D1%82%D0%BE%D0%B2-%D1%81%D1%87%D0%B8%D1%82%D0%B0%D0%B5%D0%BC-%D0%B4%D0%B5%D0%BD%D1%8C%D0%B3%D0%B8-4b854df151cd), если полученная метрика будет удовлетворять базовым условиям его применения.

CUPED достаточно простой и доступный в применении метод, который может помочь значительно сократить дисперсию и уменьшить время на принятие решений. Если у вас большой продукт и потоковые эксперименты, такие практики просто необходимы. Еще раз хочется отметить, что метод можно и нужно адаптировать и развивать под особенности продукта, в котором он используется.

> _Интенсив по математической статистике и a/b тестам ExperimentFest_ 25–26 апреля _—_ [_experiment-fest.ru/ab_course_](https://www.experiment-fest.ru/ab_course)

Может возникнуть вопрос, кто из российских компаний активно использует такой подход. Кроме нас своим опытом поделились x5, skyeng, avito

**Александра Крецу**, аналитик в SKYENG [https://www.facebook.com/aleksandra.kretsu](https://www.facebook.com/aleksandra.kretsu)

> В skyeng мы проводим много экспериментов на небольших сегментах учеников. Это сильно повышает наши требования к скорости проведения тестов, и cuped оказывается как нельзя кстати: с его помощью мы снижаем дисперсию тестовой метрики на ~30%. Это позволяет пропорционально снизить количество необходимого траффика.

**Тимур Исмагилов**, ведущий аналитик в AVITO [https://www.facebook.com/t.ismagilov](https://www.facebook.com/t.ismagilov)

> В Авито мы проводим часть экспериментов по регионам — одна группа регионов получает тестовые условия, а другая — контрольные. В этом случае считать экспериментальными единицами пользователей некорректно, и мы считаем за экспериментальную единицу целый регион. Значение целевой метрики по таким статистическим единицам имеет большую дисперсию. Чтобы сократить ее и получить статистически значимые результаты, наша практика — использовать в таких экспериментах CUPED-метрику вместо целевой метрики.

**Валерий Бабушкин**, Director of Data Science _в X5 Retail Group_ [https://www.facebook.com/valeriy.babushkin.9](https://www.facebook.com/valeriy.babushkin.9)

> Мы регулярно оцениваем эффективность различных нововведений, пилотов, запусков новых продуктов. В оффлайн бизнесе это само по себе непросто, есть множество подводных камней. Cuped позволяет значительно снизить дисперсию, не изменяя среднее значение метрик. В качестве ковариатов мы используем часовые гистограммы значений, что позволяет подобрать максимально корреллирующий с основной метрикой ковариат и тоже время эту операцию можно объяснить с точки зрения бизнеса. Дисперсия удается снизить на 40–70 %