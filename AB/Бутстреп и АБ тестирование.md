---
tags:
  - data
data_type:
  - AB tests
link: https://habr.com/ru/companies/X5Tech/articles/679842/
source: habr
author: Nazarov
company: X5
---
[[Стратификация. Как разбиение выборки повышает чувствительность AB теста]]

Привет, Хабр! В этой статье разберёмся, как с помощью бутстрепа оценивать стандартное отклонение, строить доверительные интервалы и проверять гипотезы. Узнаем, когда бутстреп незаменим, и в чём его недостатки. 

![](https://habrastorage.org/r/w1560/getpro/habr/upload_files/68c/c69/f8c/68cc69f8cc77080f1aac8fd0fbd81b41.png)

Продолжаем писать серию статей по А/Б тестированию, это наша вторая статья. Первую можно посмотреть тут: [Стратификация. Как разбиение выборки повышает чувствительность A/B теста](https://habr.com/ru/company/X5Tech/blog/596279/).

## Метрики и точность их оценки

Давайте представим, что мы работаем аналитиками в сервисе по доставке заказов онлайн-магазина. Нам поставили задачу оценить, как быстро мы выполняем заказы. У нас есть данные со временем выполнения каждого заказа, осталось выбрать метрику и оценить её значение. В этой статье положим, что мы работаем с независимыми одинаково распределенными случайными величинами. Случай зависимых случайных величин будет разобран в последующих статьях.

Самый простой вариант метрики - **среднее время выполнения заказа.** Для оценки среднего времени выполнения заказа можно взять все заказы за какой-то промежуток времени, например, за последний месяц, и вычислить среднее время их выполнения.

Допустим, мы получили оценку среднего времени доставки, равную 90 минутам. Насколько ей можно верить? Понятно, что это, скорее всего, не истинное значение среднего времени доставки. Если мы подождём ещё месяц и повторим вычисление, то получим чуть большее или чуть меньшее значение. Важно оценить стандартное отклонение полученной оценки, чтобы понять, насколько она точна, так как 90±1 минута и 90±30 минут - совсем разные ситуации.

Для среднего оценка стандартного отклонения вычисляется по формуле:

![\hat{\sigma}_{\overline{X}} = \sqrt{ \dfrac{1}{n(n-1)} \sum_{i=1}^n \left( X_i - \overline{X} \right)^2 }](https://habrastorage.org/getpro/habr/upload_files/914/ea5/e3a/914ea5e3a89a6cf50b0487db40b9daaf.svg)

где ![n](https://habrastorage.org/getpro/habr/upload_files/6e9/7d7/a6d/6e97d7a6df34b50756059dd7eb288ea6.svg)- размер выборки, ![X_i](https://habrastorage.org/getpro/habr/upload_files/2cf/d53/435/2cfd53435cfe2a53eaf7e20a2dae7c3e.svg)- случайные величины времени доставки, ![\overline{X}](https://habrastorage.org/getpro/habr/upload_files/e03/83f/277/e0383f2777f27a568b080ec8c528f85a.svg) - выборочное среднее времени доставки.

Рассмотрим пример вычисления оценки среднего и стандартного отклонения. Допустим, что у нас есть информация о 1000 доставках. Распределение времени доставки в реальной жизни может быть произвольным. В примере будем генерировать время доставки из нормального распределения со средним 90 и стандартным отклонением 20. Сгенерируем выборку, оценим среднее и стандартное отклонение среднего.

```
import numpy as npn = 1000values = np.random.normal(90, 20, n)mean = values.mean()std = values.std() / np.sqrt(n)print(f'Оценка среднего времени доставки: {mean:0.2f}')print(f'Оценка std для среднего времени доставки: {std:0.2f}')
```

```
Оценка среднего времени доставки: 90.23Оценка std для среднего времени доставки: 0.64
```

Получилось, что в нашем примере 1000 наблюдений оказалось достаточно, чтобы стандартное отклонение оценки среднего было меньше минуты.

## Квантили

Мы оценили среднее время выполнения заказа. Это хорошо, но это всего лишь “среднее по больнице”. Кто-то получает заказы быстрее, кто-то медленнее. Мы хотим, чтобы подавляющее большинство клиентов получали заказы достаточно быстро. Оценить, за сколько доставляется бОльшая часть заказов можно, например, с помощью 90% квантиля. Какой физический смысл квантиля? Если 90% квантиль равен 2 часам, то 90% заказов доставляются не более, чем за 2 часа.

![](https://habrastorage.org/r/w1560/getpro/habr/upload_files/f9f/3ba/cd1/f9f3bacd110921793d15530de019c0e0.png)

Мы легко можем оценить 90% квантиль по данным, но как оценить стандартное отклонение полученной оценки? Простой универсальной теоретической формулы для оценки стандартного отклонения квантиля нет.

Было бы хорошо, если у нас было 100 параллельных вселенных. Мы бы в каждой вселенной собрали данные, посчитали 100 квантилей и оценили стандартное отклонения по полученным значениям. Но у нас нет 100 параллельных вселенных.

![](https://habrastorage.org/r/w1560/getpro/habr/upload_files/0db/bc5/eef/0dbbc5eef35d9279fa60167e89f14302.png)

Кто-то может предложить разбить наши данные из 1000 наблюдений на 10 частей по 100 значений в каждом. В каждой части посчитать значение квантиля и оценить стандартное отклонение по этим 10 значениям. Такой подход даст **неверный** результат, так как стандартное отклонение оценки зависит от количества наблюдений, используемых при оценке значения квантиля. Чем больше данных, тем точнее оценка и меньше стандартное отклонение.

Что же делать? Оказывается, есть способ, который позволяет оценить стандартное отклонение произвольной статистики, в том числе квантиля. Он называется бутстреп.

## Бутстреп

**Бутстреп (bootstrap)** - это метод для оценки стандартных отклонений и нахождения доверительных интервалов статистических функционалов.

Разберёмся, как работает бутстреп. Напомним, что мы хотим оценить стандартное отклонение произвольной статистики. В статье мы будет оценивать стандартное отклонение оценки 90% квантиля.

Если бы мы могли получать данные из исходного распределения, то могли бы сгенерировать из этого распределения 100 выборок, посчитать по ним 100 квантилей и оценить стандартное отклонение. Истинного распределения мы не знаем, но можем его оценить по имеющимся данным.

В качестве оценки функции распределения будем использовать эмпирическую функцию распределения (ЭФР). ЭФР является несмещённой оценкой и сходится к истинной ФР при увеличении размера выборки.

Определение ФР и ЭФР

![](https://habrastorage.org/r/w1560/getpro/habr/upload_files/64a/fb1/d49/64afb1d49e395bcd76911ea55c0c5eb0.png)

![](https://habrastorage.org/r/w1560/getpro/habr/upload_files/61e/948/6b0/61e9486b0316a2a93744b0e9cdb7ebac.png)

|   |   |   |   |   |
|---|---|---|---|---|
||||||
||||||

Теоремы сходимости ЭФР к ФР

![](https://habrastorage.org/r/w1560/getpro/habr/upload_files/5cc/380/37b/5cc38037be2842ac8e4a773c2abff623.png)

Посмотрим как визуально выглядит ЭФР для данных разного размера из стандартного нормального распределения.

Код

```

```

![](https://habrastorage.org/r/w1560/getpro/habr/upload_files/2a5/5e9/168/2a55e9168e4aaf0c28b1c13e291824c1.png)

На графике видно, что при увеличении размера выборки ЭФР лучше приближает истинную функцию распределения. Если увеличить размер выборки до нескольких тысяч, то ЭФР визуально будет сложно отличить от истинной функции распределения.

Так как нам известно, что ЭФР "хорошо" приближает истинную ФР, давайте генерировать данные из неё! Как это сделать?

Сгенерировать подвыборку размера ![n](https://habrastorage.org/getpro/habr/upload_files/2f6/019/921/2f6019921c39f89fb06f8b26f3ad0ced.svg) из ЭФР - это тоже самое, что выбрать случайно с возвращением ![n](https://habrastorage.org/getpro/habr/upload_files/b27/3be/138/b273be1388312209799ab28c70ca61fe.svg) элементов из исходной выборки. Это можно сделать одной строчкой кода

```
np.random.choice(values, size=n, replace=True)
```

Теперь мы можем оценить стандартное отклонение оценки квантиля. Для этого 1000 раз сгенерируем подвыборки из ЭФР, вычислим значение статистики в каждой подвыборке и оценим стандартное отклонение получившихся значений.

```
n = 1000            # размер исходной выборкиB = 1000            # количество генерируемых подвыборокvalues = np.random.normal(90, 20, n)quantile = np.quantile(values, 0.9)bootstrap_quantiles = []for _ in range(B):    bootstrap_values = np.random.choice(values, n, True)    bootstrap_quantiles.append(np.quantile(bootstrap_values, 0.9))std = np.std(bootstrap_quantiles)print(f'Оценка 90% квантиля: {quantile:0.2f}')print(f'Оценка std для 90% квантиля: {std:0.2f}')
```

```
Оценка 90% квантиля: 115.24Оценка std для 90% квантиля: 1.56
```

Мы только что применили бутстреп для оценки стандартного отклонения 90% квантиля.

Обратим внимание на два момента:

1. Чтобы оценка стандартного отклонения была несмещённой, необходимо генерировать выборки такого же размера, как и размер исходной выборки;
    
2. Количество итераций бутстрепа рекомендуется брать в диапазоне от 1000 до 10000. Этого, как правило, хватает для получения достаточно точных результатов.
    
## Доверительные интервалы

Мы научились оценивать стандартное отклонение оценки статистики. Зная стандартное отклонение, можно интуитивно понять насколько достоверны полученные результаты. Для получения более точных результатов можно построить доверительный интервал.

**Доверительный интервал (ДИ)** - это интервал, который покрывает оцениваемый параметр с заданной вероятностью.

Строгое определение ДИ

![](https://habrastorage.org/r/w1560/getpro/habr/upload_files/a9c/a36/49d/a9ca3649d7a5ebae0e81e925867c72e7.png)

Вернёмся к примеру с доставкой из онлайн-магазина и построим ДИ среднего времени доставки. В нашей статье будем использовать 95% доверительный интервал. Если данных много, то, независимо от распределения исходных данных (предполагается, что дисперсия существует и не равна нулю), по центральной предельной теореме среднее будет распределено нормально. Для нормально распределённых статистик ДИ можно вычислить по формуле

![[\widehat{mean} - z_{1 - \alpha/2} * \widehat{std},\ \widehat{mean} + z_{1 - \alpha/2} * \widehat{std}]](https://habrastorage.org/getpro/habr/upload_files/874/b70/011/874b70011375d265424c475530cdfb1f.svg)

где ![z_{1 - \alpha/2}](https://habrastorage.org/getpro/habr/upload_files/0bf/ebe/1ff/0bfebe1ffe2d0eaa096723498bf2b6cf.svg)- квантиль стандартного нормального распределения, ![\alpha](https://habrastorage.org/getpro/habr/upload_files/2d2/777/ad3/2d2777ad3ea7e8f47ecfe84f1d70cee2.svg)- уровень значимости. Для 95% доверительного интервала уровень значимости равен 0.05.

![](https://habrastorage.org/r/w1560/getpro/habr/upload_files/721/bf0/bae/721bf0bae40298069f71ae3c0b6b7165.png)

Для построения ДИ квантиля мы, как вы наверное уже догадались, будем использовать бутстреп. ДИ с помощью бутстрепа можно построить тремя способами.

Первый способ аналогичен тому, как мы строили ДИ для среднего. Для его вычисления нужно выполнить следующие три шага:

1. оценить значение квантиля по исходным данным;
    
2. с помощью бутстрепа оценить стандартное отклонение оценки квантиля;
    
3. по формуле вычислить ДИ
    
    ![[\widehat{pe} - z_{1 - \alpha/2} * \widehat{std},\ \widehat{pe} + z_{1 - \alpha/2} * \widehat{std}]](https://habrastorage.org/getpro/habr/upload_files/ff1/62d/5dd/ff162d5ddaa4e5bee0e1acc212263581.svg),
    
    где ![\widehat{pe}](https://habrastorage.org/getpro/habr/upload_files/f2d/85c/4d2/f2d85c4d2e9bc4c210e9ffbcee80f075.svg) - это точечная оценка (point estimation).
    

Такой ДИ называется **нормальным доверительным интервалом**.

Нормальный доверительный интервал отлично подходит, когда распределение статистики близко к нормальному распределению. Если распределение статистики несимметричное, то нормальный доверительный интервал может давать странный результат. На графике ниже изображена ситуация, когда граница доверительного интервала выходит за минимальное значение распределения.

![](https://habrastorage.org/r/w1560/getpro/habr/upload_files/3a8/010/8e9/3a80108e925eaea6769234aacb262290.png)

В случае несимметричных распределений мы можем использовать **перцентильный доверительный интервал**. Чтобы построить перцентильный ДИ, нужно отрезать с каждой стороны по ![\alpha/2](https://habrastorage.org/getpro/habr/upload_files/a74/dde/11e/a74dde11e041234e4abfb5351070b1e8.svg)площади распределения. Для 95% ДИ нужно отрезать по 2.5%. На практике для вычисления границ ДИ нужно оценить квантиль ![q_{\alpha / 2}](https://habrastorage.org/getpro/habr/upload_files/29c/81d/5f7/29c81d5f75c8d565b51fb191b016c93a.svg)и ![q_{1 - \alpha / 2}](https://habrastorage.org/getpro/habr/upload_files/4a8/bd7/e3d/4a8bd7e3dbbf84044461467963206b99.svg)по значениям статистик полученных с помощью бутстрепа. Доверительный интервал будет иметь следующий вид

![[\hat{q}_{\alpha / 2},\ \hat{q}_{1 - \alpha / 2}]](https://habrastorage.org/getpro/habr/upload_files/c50/526/850/c50526850935b3ab97d42883ef7c6d91.svg)

![](https://habrastorage.org/r/w1560/getpro/habr/upload_files/854/341/63c/85434163cf36527874cbe76697db629f.png)

Существует ещё один вариант - **центральный доверительный интервал.** Его границы равны

![[2 * \widehat{pe} - \hat{q}_{1 - \alpha / 2},\ 2 * \widehat{pe} - \hat{q}_{\alpha / 2}]](https://habrastorage.org/getpro/habr/upload_files/ee0/ef4/331/ee0ef433110db23df93ab93a5aaa1989.svg)

На первый взгляд этот доверительный интервал кажется нелогичным, но он имеет под собой строгое математическое обоснование.

![](https://habrastorage.org/r/w1560/getpro/habr/upload_files/269/eeb/733/269eeb7337cefc382e56dc308e5b4780.png)

Центральный ДИ для логнормального распределения смещён в сторону с нулевой плотностью. Это можно интерпретировать как стремление перестраховаться на случай, если у нас неполная информация о распределении, и левее нуля на самом деле могут быть значения.

Мы познакомились с тремя способами построения доверительных интервалов с помощью бутстрепа. Ниже приведён пример кода построения этих ДИ.

Код

```

```

![](https://habrastorage.org/r/w1560/getpro/habr/upload_files/32a/5c7/d36/32a5c7d36e709940c7b59ec5d7103ae1.png)

## Бутстреп и А/Б тестирование

Мы научились строить доверительные интервалы. С помощью доверительного интервала можно не только получать дополнительную информацию о значении метрики, но и проверять статистические гипотезы. Чтобы проверить гипотезу о равенстве квантилей на уровне значимости 5% достаточно построить 95% доверительный интервал для разности квантилей между группами. Если ноль находится вне доверительного интервала, то отличия статистически значимы, иначе нет.

![](https://habrastorage.org/r/w1560/getpro/habr/upload_files/b62/724/af2/b62724af2080073a5c0a4b832d375141.png)

Опишем ещё раз алгоритм проверки гипотез о равенстве двух произвольных метрик с помощью бутстрепа:

1. Генерируем пару подвыборок того же размера из исходных данных контрольной и экспериментальной групп;
    
2. Считаем метрики (реализация оценки метрики) для каждой из групп;
    
3. Вычисляем разность метрик, сохраняем полученное значение;
    
4. Повторяем шаги 1-3 от 1000 до 10000 раз;
    
5. Строим доверительный интервал с уровнем значимости ![\alpha](https://habrastorage.org/getpro/habr/upload_files/0e1/772/f61/0e1772f616d3e681bf684f5c65200a9e.svg);
    
6. Если 0 не принадлежит ДИ, то отличия статистически значимы на уровне значимости ![\alpha](https://habrastorage.org/getpro/habr/upload_files/72c/6b8/e1f/72c6b8e1f220de9720bf81c7f4ba6567.svg), иначе нет. 
    

Посмотрим, как этот алгоритм можно реализовать в коде. Для примера, при генерации данных в экспериментальной группе уменьшим дисперсию, это приведёт к уменьшению значения 90% квантиля.

```
n = 1000B = 10000alpha = 0.05values_a = np.random.normal(90, 20, n)values_b = np.random.normal(90, 15, n)pe = np.quantile(values_b, 0.9) - np.quantile(values_a, 0.9)bootstrap_values_a = np.random.choice(values_a, (B, n), True)bootstrap_metrics_a = np.quantile(bootstrap_values_a, 0.9, axis=1)bootstrap_values_b = np.random.choice(values_b, (B, n), True)bootstrap_metrics_b = np.quantile(bootstrap_values_b, 0.9, axis=1)bootstrap_stats = bootstrap_metrics_b - bootstrap_metrics_aci = get_percentile_ci(bootstrap_stats, pe, alpha)has_effect = not (ci[0] < 0 < ci[1])print(f'Значение 90% квантиля изменилось на: {pe:0.2f}')print(f'{((1 - alpha) * 100)}% доверительный интервал: ({ci[0]:0.2f}, {ci[1]:0.2f})')print(f'Отличия статистически значимые: {has_effect}')
```

```
Значение 90% квантиля изменилось на: -6.6995.0% доверительный интервал: (-9.66, -3.41)Отличия статистически значимые: True
```

Получилось, что 90% квантиль статистически значимо уменьшился.

В данном примере для построения ДИ использовался перцентильный ДИ. На практике все три способа построения ДИ зачастую дают схожие по точности результаты. Однако могут быть и исключения, результат будет зависеть от природы данных и сравниваемых метрик. Чтобы понять какой способ лучше работает в вашей ситуации, нужно оценить ошибки первого и второго рода по историческим данным. Как это сделать можно прочитать в нашей прошлой статье [Стратификация. Как разбиение выборки повышает чувствительность A/B теста](https://habr.com/ru/company/X5Tech/blog/596279/).

## Ограничения бутстрепа

Бутстреп является весьма универсальным методом. Он позволяет численно исследовать свойства распределений произвольных статистик, а не только квантиля. Это делает его незаменимым для построения доверительных интервалов и проверки гипотез с нетривиальными метриками.

Если бутстреп так хорош, то почему его не используют во всех задачах? Основной недостаток бутстрепа – его скорость работы. Применение бутстрепа является вычислительно трудоёмкой процедурой. Это становится ощутимо, когда приходится работать с большими объёмами данных и многократно применять бутстреп. Вычисления могут занимать часы, дни и даже недели.

Обратим внимание, что во всех примерах выше предполагалось, что мы имеем дело с независимыми одинаково распределёнными случайными величинами. В таких ситуациях для генерации подвыборок можно случайно выбирать значения из исходной выборки. Если же исходные данные зависимы и имеют сложную природу, то при генерации подвыборок нужно это учесть, иначе оценка распределения статистики с помощью бутстрепа может плохо приближать истинное распределение.

Важно не забывать про качество исходных данных, с которыми работает бутстреп. Если эти данные нерепрезентативны и плохо отражают реальное состояние, то достоверных результатов ожидать не стоит.

### Заключение

Мы разобрали статистический метод, позволяющий получать оценки стандартного отклонения и строить доверительные интервалы самых нетривиальных статистик. Обсудили, как применять бутстреп для проверки гипотез, когда он незаменим и в чём его недостатки.