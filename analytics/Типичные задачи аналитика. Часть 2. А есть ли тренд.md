---
tags:
  - data
author: Yuldashev
link: https://habr.com/ru/articles/795251/
source: habr
data_type:
  - Analytics
---
#### Введение

В [первой части](https://habr.com/ru/articles/787098/) статьи на Habr мы рассмотрели классические подходы к оценке изменений метрики при условии ее стационарности. В этом контексте статистические критерии, применяемые в [A/B тестировании](https://habr.com/ru/articles/781060/), оказались весьма эффективными.

Однако, если существует стабильный тренд, например, среднемесячная аудитория увеличивается из года в год, оценка разницы средних за два смежных периода времени может быть некорректной. В таком случае среднее значение предыдущего периода всегда будет отличаться от среднего постпериода, и это часто может быть не связано с исследуемым функционалом.

Одна из причин — тренд не всегда зависит от действий компании и часто является следствием внешних условий. Например, рост аудитории может быть связан с увеличением благосостояния населения, масштабированием бизнеса или сезонными факторами.

Таким образом, наличие или отсутствие тренда является важным аспектом анализа данных. Рассмотрим несколько успешных и неудачных подходов, которые можно применять для решения этой задачи.

## Визуальный анализ

В контексте анализа временных рядов визуальный анализ играет важную роль в определении тренда, но у него есть очевидные недостатки и ограничения. Субъективность восприятия, неопределенность результатов и ограничения в обработке больших объемов данных - лишь некоторые из аспектов, которые стоит учитывать при использовании этого метода.

Визуальный анализ полезен для первичной оценки данных, выявления общих паттернов и трендов, а также для выбора подходящего метода дальнейшего анализа. Он помогает понять тип зависимости в данных, выделить основные характеристики временного ряда и сформулировать предварительные гипотезы.

Ниже рассмотрим несколько примеров:

Код Python

```

```

![](https://habrastorage.org/r/w1560/getpro/habr/upload_files/e1f/cb5/bc7/e1fcb5bc7941faaa076382c7dc108da7.png)

![](https://habrastorage.org/r/w1560/getpro/habr/upload_files/6f7/7f5/67a/6f77f567af768b23dccfad9fcecf9c89.png)

![](https://habrastorage.org/r/w1560/getpro/habr/upload_files/e5b/b5a/f12/e5bb5af12ab1a017e50c527ed9ed6b24.png)

В случае, когда дисперсия в данных низкая, обнаружение тренда становится относительно простым, так как данные имеют менее выраженные колебания, что упрощает его визуализацию. Однако в более типичных сценариях, когда данные шумные, как на втором графике, выделение определенного тренда становится проблематичным. В таких ситуациях можно попытаться уменьшить влияние шума с помощью методов сглаживания, таких как скользящее среднее или экспоненциальное сглаживание. Эти методы также могут иметь свои недостатки и привести к ошибкам в анализе. Например, скользящее среднее, основываясь на предыдущих значениях, может пропустить недавно возникший тренд или изменение, что снизит его чувствительность к новым данным.

Стоит помнить, что визуальный анализ должен использоваться в сочетании с другими методами анализа, так как только на его основе делать окончательные выводы может быть недостаточно надежно.

## Линейная регрессия

Линейная регрессия это один из наиболее популярных и эффективных методов для определения и оценки тренда. Она является неотъемлемой частью [курсов](https://ocw.mit.edu/courses/18-655-mathematical-statistics-spring-2016/) по математической статистике и [анализу данных](https://grow.google/certificates/data-analytics/).

Одно из главных преимуществ линейной регрессии является ее простота, интерпретируемость, малые требования к вычислительным ресурсам, а также ее эффективность при линейных взаимосвязях.

Однако последний плюс в тоже время является и минусом - линейная регрессия может быть недостаточно гибкой, чтобы хорошо аппроксимировать сложные взаимосвязи в данных. Если тренд имеет нелинейную форму, линейная регрессия может построить неверную модель.

Линейная регрессия предполагает независимость ошибок и их одинаковое распределение (гомоскедастичность). Нарушение этих предположений может привести к некорректным выводам.

Построение регрессии чаще всего происходит по следующим этапам

- **Подготовка датасета.**
    
- **Применение линейной регрессии.**
    
- **Проверка гомоскедастичности.**
    
    - Гомоскедастичность означает, что дисперсия ошибок модели постоянна для всех значений предикторов. Иными словами, разброс ошибок не зависит от уровня предсказываемой переменной. Почему это важно делать можно подробнее [почитать тут](https://studfile.net/preview/2069367/page:20/). В данном примере линейная зависимость, поэтому будем использовать Breusch-Pagan test.
        
- **Вычислить** R² **и доверительный интервал угла наклона.**
    
    - R² в данном случае показывает качество модели. Чем он ближе к 1, тем большее кол-во данных объясняется моделью. Но не всегда низкие значения R² свидетельствуют о несостоятельности модели. В случае когда данные очень шумные и имеются выбросы, R² будет как правило довольно низким, но это не отрицает наличие линейных зависимостей или явного тренда. Детальней рассмотрим ниже.
        
- **Проверка на независимость ошибок**
    
    - Независимость ошибок в модели линейной регрессии важна для получения корректных оценок параметров. Для этого может применяться статистика, такая как тест Дарбина-Уотсона, который проверяет наличие автокорреляции в остатках модели. Подробней с ней можно познакомиться [здесь](https://habr.com/ru/articles/693402/). Обычно, когда статистика Дарбина-Уотсона находится в пределах 1.5 до 2.5, это считается приемлемым показателем отсутствия автокорреляции. Однако, для точной интерпретации, можно использовать таблицы критических значений для теста Дарбина-Уотсона или статистические пакеты, которые автоматически вычисляют p-значение для данной статистики.
        
- **Вычисление доверительного интервала наклона с помощью бутстрапа.**
    
    - О бутстрапе подробно было описано в предыдущей статье. Здесь лишь уточним что такой метод нужен для того чтобы избежать случайных результатов в данных с широким интервалом. Построение 1000 моделей с помощью бутсрапа позволит оценить интервал в рамках которого может изменять угол наклона нашего тренда.
        

Рассмотрим далее несколько примеров применения линейной регрессии для определения тренда на Python и Scipy , а также основные трудности с которым можно столкнуться при построении линейной регрессии.

Построим для примера модель в которой выполняются все условие.

Код Python

```

```

![](https://habrastorage.org/r/w1560/getpro/habr/upload_files/01f/ee7/43a/01fee743a2e3053491c069db097ce3cd.png)

Полученные результаты указывают на присутствие тренда в данных, с углом наклона (slope) в интервале от ~0.012 до 0.018. Другими словами, каждый день метрика увеличивается от 0.012 до 0.018 единиц. Проверка гомоскедастичности подтверждает выполнение условий для построения регрессии, а анализ независимости ошибок показывает, что различия не являются статистически значимыми.

![](https://habrastorage.org/r/w1560/getpro/habr/upload_files/bde/c5a/b0a/bdec5ab0a85417811048cc0da0fbdb8f.png)

Таким образом, полученные результаты дают представление о характере тренда и его величине, что затруднительно сделать только с помощью визуального анализа.

### Проверка на гомоскедастичность.

Наличие высокой гетероскедастичности создает препятствия для построения модели. Давайте рассмотрим, какие последствия могут возникнуть при построении линейной регрессии при игнорировании этой проверки.

Код Python

```

```

Тест Breusch-Pagan сигналиризует о том что разброс ошибок зависим от уровня предсказываемой переменной

![](https://habrastorage.org/r/w1560/getpro/habr/upload_files/1f5/0f7/891/1f50f7891066fa7abb708b6ff91ea5c6.png)

Результаты могут быть примерно такими:

![](https://habrastorage.org/r/w1560/getpro/habr/upload_files/17c/65b/3bd/17c65b3bd359e7de33966736d539b800.png)

![](https://habrastorage.org/r/w1560/getpro/habr/upload_files/723/16a/63d/72316a63dc22cd157c7cb93819223100.png)

Получаемые результаты при анализе данных могут быть непостоянными, и один и тот же код может демонстрировать как положительный, так и отрицательный тренд. В таких случаях выводы о наличии тренда остаются на усмотрение случайных факторов. Более подробную информацию о том, как бороться с гетероскедастичностью, можно найти [здесь](https://books.econ.msu.ru/Introduction-to-Econometrics/chap05/5.3/), однако решение этой проблемы часто бывает сложным, и определить явное наличие тренда в данных может быть затруднительно.

### Оценка R²

Внимательный читатель мог заметить, что в первом примере была пропущена оценка коэффициента детерминации R². Возвращаясь к этому, результаты анализа показывают, что R² находится в диапазоне между 0.06 и 0.14. Это свидетельствует о том, что модель довольно слабо описывает данные, что, в целом, подтверждает наше предположение о том, что такая модель характерна для данных с высоким уровнем шума.

Ниже рассмотрим два дополнительных примера, иллюстрирующих, почему низкий R² не всегда свидетельствует о плохом качестве модели, а может быть следствием особенностей данных.

Код Python

```

```

![](https://habrastorage.org/r/w1560/getpro/habr/upload_files/6cd/535/9d3/6cd5359d39ed45500161276f7f620c2f.png)

За период среднее значение выросло в 2 раза trend_max = 100, но из за большого кол-ва выбросов и шума в данных R² довольно низкий. В таких случаях важно понимать что R², вопреки расхожим заблуждениям не говорит о качестве модели, а лишь о том насколько она точно аппроксимирует нашу фукнцию, и в случае с большим количеством выбросов показатель всегда будет достаточно низкий. Важно в таком случае обращать внимание на другие тесты и на slope.

![](https://habrastorage.org/r/w1560/getpro/habr/upload_files/221/beb/d4f/221bebd4f7bd5f6a2d15f5d70121dfd2.png)

Также мы не упомянули важную слабость линейной регрессии - ее неустойчивость к выбросам. Это выражается в широких доверительных интервалах для коэффициентов наклона. Для улучшения качества модели часто требуется удаление выбросов или применение более устойчивых методов, способных лучше справляться с наличием аномалий в данных. Рассмотрим некоторые из них далее.

## Mann-Kendall test

Метод Манн-Кендалла представляет собой непараметрический тест, который определяет наличие или отсутствие тренда на рангах данных. Он не зависит от конкретных значений метрики, а лишь учитывает их порядок, то есть знак разности между последовательными наблюдениями.

Среди преимуществ этого теста можно отметить его независимость от выбросов и способность выявлять монотонные зависимости даже в случае нелинейной формы зависимости. Однако следует проявлять осторожность при его использовании в практических задачах, поскольку уже небольшой тренд может быть признан статистически значимым. Это может привести к неправильным выводам с точки зрения бизнес-логики, где незначительные изменения могут быть недостаточно значимыми.

Давайте рассмотрим следующий пример для наглядного представления.

Код Python

```

```

![](https://habrastorage.org/r/w1560/getpro/habr/upload_files/038/45d/328/03845d328a33c5351fd6a305631ee137.png)

Таким образом, тест Манна-Кендалла, примененный к данному примеру, покажет наличие тренда в 100 из 100 случаев, даже если этот тренд является незначительным.

Для данного примера даже бустрапированная метрика Манна-Кендалла всегда будет указывать на наличие тренда. Помимо значения p-value, тест Манна-Кендалла возвращает статистику tau, которая меняется от -1 до 1. Значение 1 указывает на положительную монотонность, -1 на отрицательную, а 0 на отсутствие монотонности. Однако эта метрика сложна для интерпретации, поскольку не предоставляет информацию о величине тренда. В текущем примере значение tau около 0.6, что указывает на положительную монотонность, но не даёт информации о конкретной величине тренда.

![](https://habrastorage.org/r/w1560/getpro/habr/upload_files/ed1/33a/e03/ed133ae033d3e8ea90bd9f2f3f7ee95e.png)

Таким образом, после положительного заключения о наличии тренда в тесте Ман-Кендалла необходимо дополнительно проводить оценку угла наклона другими тестами. Линейная регрессия на тех же данные показывает что slope минимальный.

![](https://habrastorage.org/r/w1560/getpro/habr/upload_files/4db/92a/c17/4db92ac17dc27cf18fdba8b08bbcbb04.png)

Если есть возможность оценить угол наклона на втором шаге, то теряется смысл в самом тесте Ман-Кендалла. Более того, частые срабатывания теста на незначительных трендах могут привести к неправильным выводам аналитика, что поднимает вопросы о его применимости в реальных сценариях.

Несмотря на это, к достоинствам теста Манна-Кендалла следует отнести его способность быстро обнаруживать нелинейные тренды, что может быть полезно в некоторых ситуациях.

## Spearman’s Rank Correlation Test

Так же, как и тест Манн-Кендалла, тест Спирмена основан на анализе рангов. В тесте Спирмена рассчитывается коэффициент корреляции Спирмена, который измеряет степень монотонной связи между двумя переменными.

Код Python

```

```

![](https://habrastorage.org/r/w1560/getpro/habr/upload_files/629/eba/9c5/629eba9c581d9a9fa1af7547896833e2.png)

Недостатки и преимущества теста Ман-Кендалла также переносятся и на тест Спирмана, в том числе чувствительность к низким значениям углов тренда, что также ставит под сомнение его применимость во многих задачах где цель определить наличие или отсутствие тренда и понять его характер.

## Repeated median regression (RMR)

Проблема неустойчивости линейной регрессии к выбросам привела к развитию целого семейства методов, робастных к редким большим и маленьким значениям. Идея проста: для каждой точки в выборке строятся линии, проходящая через неё и все остальные точки, и затем вычисляется угол наклона этой линии. Затем из всех полученных углов наклона выбирается медианное значение. Этот процесс повторяется для каждой точки, и затем снова вычисляется медиана всех медиан.

**Когда он хорошо работает:**

- **С выбросами в данных:** Метод робастен к наличию выбросов и аномалий, что делает его полезным в ситуациях, где классическая линейная регрессия может дать искаженные результаты из-за выбросов.
    
- **Нелинейные зависимости:** Этот метод может быть эффективен при аппроксимации нелинейных зависимостей, так как он не ограничен предположением о линейности отношения между переменными.
    
- **Работа с разнородными данными:** Метод может быть эффективен при работе с данными, содержащими шум или неоднородные структуры, так как он оценивает углы наклона, учитывая различия в данных.
    

Важно отметить, что, этот метод может потребовать дополнительных вычислительных ресурсов, особенно при обработке больших объемов данных.

Код Python

```

```

![](https://habrastorage.org/r/w1560/getpro/habr/upload_files/3e6/5d8/6e9/3e65d86e9794c113ab3d10461c18ea8d.png)

Исходя из результатов, видно, что этот метод не только устойчив к выбросам, но и эффективно работает в связке с бутстрапом. Другим преимуществом является то, что этот метод менее чувствителен к нарушениям гомоскедастичности и может давать хорошие результаты, даже если дисперсия ошибок не является постоянной на всех уровнях предиктора. Однако важно понимать, что он менее чувствителен, и при высоких значениях дисперсии качество модели также ухудшается. Ниже приведен результат выполнения при hetero=30.

![](https://habrastorage.org/r/w1560/getpro/habr/upload_files/5ed/9ba/0fa/5ed9ba0fab1f603122f7012bd4028a7c.png)

Как видно RMR выдает значение приближенные к реальным, в то время как у классической линейной регрессии интервал становится крайне широким.

## Заключение

Мы рассмотрели несколько популярных методов для определения тренда. Каждый из них имеет свои сильные и слабые стороны и выбор конкретного метода зависит от целей анализа, характера данных и требуемой точности оценки тренда.  
В данной статье мы практически не затронули методы которые используется при анализе тренда в нелинейных взаимосвязях таких как [полиномиальная регрессия,](https://habr.com/ru/articles/571058/) экспоненциальная регрессия, логистическая регрессия и другие. Или более сложные алгоритмы такие как ARIMA, SARIMA и другие.

Дополнительные проверки на автокоррелляцию и гетероскедастичность можно найти [https://www.statsmodels.org/stable/diagnostic.html](https://www.statsmodels.org/stable/diagnostic.html).

О том чем это чревата неосторожная очистка выбросов можно почитать в статье [https://habr.com/ru/articles/781060/](https://habr.com/ru/articles/781060/)

## Авторы

[Roman Rudnitskiy](https://www.linkedin.com/in/rudnitskiy)

[Marat Yuldashev](https://linkedin.com/in/marat-yuldashev)

[Mikhail Tretyakov](https://www.linkedin.com/in/m-tretyakov)